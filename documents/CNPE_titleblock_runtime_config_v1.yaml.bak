schema_version: '2.0'
project: CNPE_DWG_DXF_Titleblock_Extraction
principle:
  production_has_no_calibration_layers: true
  roi_primary_coordinate_system: rb_offset_scaled
  rb_offset_definition:
    dx_right: outer_xmax - roi_xmax
    dx_left: outer_xmax - roi_xmin
    dy_bottom: roi_ymin - outer_ymin
    dy_top: roi_ymax - outer_ymin
  roi_restore_formula:
    xmin: outer_xmax - dx_left * sx
    xmax: outer_xmax - dx_right * sx
    ymin: outer_ymin + dy_bottom * sy
    ymax: outer_ymin + dy_top * sy
  note: rb_offset 中的数值来自 1:1 标准图框标定；运行时需按外框拟合得到的 sx/sy 进行缩放以适配任意比例图框。
pipeline:
- step: 1
  name: dwg_to_dxf
  input: dwg files uploaded via web
  output: dxf files (intermediate, not exported to user)
  implementation_hint: ODA File Converter CLI or ODA Drawings SDK; offline LAN compatible
- step: 2
  name: frame_candidate_detection
  logic:
  - 解析 DXF：展开 INSERT（块）递归收集 TEXT/MTEXT/ATTRIB；同时收集闭合矩形（优先 LWPOLYLINE closed）
  - 生成候选外框：按面积排序（优先最大矩形），并允许一图多框
  - 对每个候选外框：进入 Step3 复核（锚点 ROI + 文字命中）
- step: 3
  name: frame_verification_by_anchor_roi
  logic:
  - 对候选外框，先做纸张尺寸拟合，得到 paper_variant 与缩放因子 sx/sy（见 scale_fit）
  - 尝试 ROI profile（BASE10/SMALL5）：在缩放后的 anchor ROI 内搜索锚点文本（CNPE 或 中国核电工程有限公司）
  - 命中则判定为有效图框；若都不命中则丢弃该外框候选
- step: 4
  name: scale_consistency_check
  logic:
  - 量取几何缩放：sx=W_obs/W_canon, sy=H_obs/H_canon；geom_scale = (sx+sy)/2
  - 读取比例文本（scale_text，例如 1:100），解析出 denominator=X
  - 若 |geom_scale - X| 超过阈值则 flags+=['比例不一致']，但继续运行
- step: 5
  name: field_roi_extract_and_text_parse
  logic:
  - 按选定 roi_profile 的字段 rb_offset，结合 sx/sy 还原各字段 ROI（绝对坐标）
  - 在 ROI 内提取文本（TEXT/MTEXT/ATTRIB），清理格式码，按 y 分行/按 x 排序拼接
  - 对字段做正则/词典解析，得到结构化参数（工程号/子项号/内外部编码/图幅/专业/比例/张数/标题/版次/状态/日期）
  - 将结果存入后续拆分、重命名、打印与文档生成模块的中间结构
outer_frame_detection:
  preferred_entities:
  - LWPOLYLINE(closed)
  - POLYLINE(closed)
  fallback: reconstruct rectangle from LINE clusters
  rectangle_acceptance:
    min_area_rank: top-N by area per layout
    orthogonality_tol_deg: 1.0
  multi_frame_in_one_dxf: true
scale_fit:
  canonical_variants:
    CNPE_A0+1_2_2016:
      W: 1783.999999995256
      H: 840.9999999966367
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A0+1_4_2016:
      W: 1486.999999995256
      H: 840.9999999966366
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A0+1_8_2016:
      W: 1337.999999995256
      H: 840.9999999966366
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A0H_2016:
      W: 840.9999999965075
      H: 1188.9999999950523
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A0_2016:
      W: 1188.9999999952565
      H: 840.9999999966366
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A1+1_2016:
      W: 1682.0
      H: 594.0
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A1+1_2_2016:
      W: 1261.0
      H: 594.0
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A1+1_4_2016:
      W: 1051.0
      H: 594.0
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A1H_2016:
      W: 594.0
      H: 841.0
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A1_2016:
      W: 841.0
      H: 593.9999999999998
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A1_FLOW_2016:
      W: 841.0
      H: 593.9999999999998
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A2_2016:
      W: 594.0000000000001
      H: 420.00000000000006
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A2_plus_0_5L_2016:
      W: 891.0000000000001
      H: 420.0000000000001
      roi_profile_id_default: RB_PROFILE_BASE10
    CNPE_A3_2016:
      W: 420.00000000000006
      H: 297.0
      roi_profile_id_default: RB_PROFILE_SMALL5
    CNPE_A4_2016:
      W: 210.0
      H: 297.0
      roi_profile_id_default: RB_PROFILE_SMALL5
  fit_method:
    allow_rotation: true
    uniform_scale_required: true
    uniform_scale_tol_rel: 0.02
    fit_error_metric: max_rel_error(W,H)
  outputs:
  - paper_variant_id
  - paper_size_geom
  - sx
  - sy
  - geom_scale_factor
roi_profiles:
  RB_PROFILE_BASE10:
    description: CNPE 大图幅/标准版图签：以外框右下角为基准，锚点区 dx_right≈10（其余字段相对关系与之配套）。
    tolerance_abs: 0.5
    fields_rb_offset_1to1:
      外层矩形:
      - 0.0
      - 1188.9999999952565
      - 0.0
      - 840.9999999966366
      工程号:
      - 96.000000000525
      - 116.00000000037198
      - 41.99999999977991
      - 51.99999999973989
      子项号:
      - 64.00000000068508
      - 84.00000000058299
      - 41.99999999977991
      - 51.99999999973989
      内部编码:
      - 10.00000000099817
      - 52.00000000073601
      - 41.99999999977991
      - 51.99999999973989
      外部编码:
      - 10.197553726666001
      - 190.19755372761904
      - 84.00000017606317
      - 94.0000001760632
      图幅:
      - 10.07999999995809
      - 26.000000000939053
      - 33.999999999841755
      - 41.99999999977991
      专业:
      - 10.07999999995809
      - 26.000000000939053
      - 25.999999999892687
      - 33.999999999841755
      比例:
      - 10.00000000099817
      - 26.000000000939053
      - 17.999999999921787
      - 25.999999999892687
      张数:
      - 10.000000000001137
      - 38.00000000083696
      - 9.99999999998364
      - 17.999999999921787
      图纸标题:
      - 38.00000000083696
      - 128.00000000037198
      - 9.999999999961737
      - 41.99999999977991
      版次:
      - 178.19755372761904
      - 189.99999999994202
      - 118.0000001760632
      - 141.7621903190359
      状态:
      - 144.19755372761915
      - 160.19755372761915
      - 118.0000001760632
      - 141.7621903190359
      日期:
      - 160.19755372761915
      - 178.19755372761904
      - 118.0000001760632
      - 141.7621903190359
      图框定位-中国核电工程有限公司:
      - 10.000000000974069
      - 190.00000000095406
      - 51.99999999973989
      - 67.99999999973988
  RB_PROFILE_SMALL5:
    description: CNPE 小图幅紧凑版图签：相对BASE整体约-5（dx/dy均减5），锚点区 dx_right≈5。已验证适用于A3与A4。
    tolerance_abs: 0.5
    fields_rb_offset_1to1:
      外层矩形:
      - 0.0
      - 420.00000000000006
      - 0.0
      - 297.0
      工程号:
      - 91.00000000052444
      - 111.0000000003717
      - 36.99999999979627
      - 46.999999999756255
      子项号:
      - 59.000000000684395
      - 79.00000000058259
      - 36.99999999979627
      - 46.999999999756255
      内部编码:
      - 5.000000000997318
      - 47.00000000073544
      - 36.99999999979627
      - 46.999999999756255
      外部编码:
      - 5.197553726665433
      - 185.1975537276186
      - 79.0000001760796
      - 89.0000001760796
      图幅:
      - 5.0799999999580905
      - 21.00000000093911
      - 28.999999999858062
      - 36.99999999979627
      专业:
      - 5.0799999999580905
      - 21.00000000093911
      - 20.99999999990905
      - 28.999999999858062
      比例:
      - 5.000000000997318
      - 21.00000000093911
      - 12.999999999938154
      - 20.99999999990905
      张数:
      - 5.000000000000512
      - 33.00000000083719
      - 5.0
      - 12.999999999938154
      图纸标题:
      - 33.00000000083719
      - 123.0000000003717
      - 4.999999999978058
      - 36.99999999979627
      版次:
      - 173.19755372761864
      - 184.9999999999419
      - 113.0000001760796
      - 136.76219031905225
      状态:
      - 139.19755372761864
      - 155.19755372761864
      - 113.0000001760796
      - 136.76219031905225
      日期:
      - 155.19755372761864
      - 173.19755372761864
      - 113.0000001760796
      - 136.76219031905225
      图框定位-中国核电工程有限公司:
      - 5.000000000974126
      - 185.0000000009538
      - 46.999999999756255
      - 62.999999999756255
anchor:
  search_text_any_of:
  - CNPE
  - 中国核电工程有限公司
  profile_priority:
  - RB_PROFILE_BASE10
  - RB_PROFILE_SMALL5
  match_policy: any_hit_accept
field_definitions:
  external_code:
    purpose: 图纸外部编码
    extract_roi_field_name: 外部编码
    parse:
      type: docno_plus_fixed19
      header: DOC.NO
      fixed_len: 19
      charset: A-Z0-9
  internal_code:
    purpose: 图纸内部编码（专用ROI框内读取全部文本）
    extract_roi_field_name: 内部编码
    parse:
      type: regex
      # 你已确认：内部编码为 XXXXXXX-XXXXX-XXX，且图纸末段从 001 开始递增
      # 这里先按“7位+5位+3位数字”约束；若前两段位数/字符集有变化，以样例为准再调整
      pattern: ^[A-Z0-9]{7}-[A-Z0-9]{5}-[0-9]{3}$
  engineering_no:
    purpose: 工程号（4位数字；与前端 project_no 概念区分，但默认值可能相同）
    extract_roi_field_name: 工程号
    parse:
      type: regex
      pattern: ^[0-9]{4}$
  subitem_no:
    purpose: 子项号（用于封面与目录）
    extract_roi_field_name: 子项号
    parse:
      type: text_exact_or_lexicon
      lexicon_optional: true
  # system_no 已废弃：你已确认改为“系统代码/系统名称”，并且来源为前端输入（默认 NA）
  paper_size_text:
    purpose: 图幅文本（A0/A1/A2/A3/A4 或特殊）
    extract_roi_field_name: 图幅
    parse:
      type: text
  discipline:
    purpose: 专业（例如 结构）
    extract_roi_field_name: 专业
    parse:
      type: text
  scale_text:
    purpose: 比例文本（1:X）
    extract_roi_field_name: 比例
    parse:
      type: regex
      pattern: ^1[:：](\d+(?:\.\d+)?)$
      output:
        scale_denominator: 1
  page_info:
    purpose: 张数信息（共N张 第M张）
    extract_roi_field_name: 张数
    parse:
      type: regex
      pattern: 共\s*(\d+)\s*张.*第\s*(\d+)\s*张
      output:
        page_total: 1
        page_index: 2
  title_cn:
    purpose: 中文标题（含块内/多行）
    extract_roi_field_name: 图纸标题
    parse:
      type: text_multiline
  revision:
    purpose: 版次（取同列最新非空）
    extract_roi_field_name: 版次
    parse:
      type: latest_nonempty_in_column
  status:
    purpose: 状态（取同列最新非空）
    extract_roi_field_name: 状态
    parse:
      type: latest_nonempty_in_column
  date:
    purpose: 日期（当前阶段可不参与业务逻辑，但保留）
    extract_roi_field_name: 日期
    parse:
      type: latest_nonempty_in_column_or_text
tolerance:
  roi_margin_percent: 0.02
  text_grouping:
    y_cluster_abs: 1.0
    line_join: '

      '
  scale_mismatch:
    abs_tol: 0.5
    rel_tol: 0.02
    flag_name: 比例不一致
    continue_on_mismatch: true
