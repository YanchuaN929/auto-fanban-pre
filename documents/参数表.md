# 文档生成模块参数规范（重构版草案）

> 范围：**封面（Word+PDF）/目录（Excel+PDF）/设计文件（Excel+PDF）/IED计划（Excel+PDF，可选）**  
> 约束：DXF 仅作为中间文件，不对用户输出；文档生成模块只消费“图框识别/图签提取”后的结构化数据。  
> 模板：`documents_bin/` 下的 xlsx/docx（已做结构扫描，目录/设计/IED 的表头与合并区域可直接固化）。

---

## 0) 你需要先确认的 6 个问题（决定参数边界）

1. **封面模板三选一规则（非 1818）**：`封面模板文件.docx / 封面模板文件压力容器版.docx / 封面模板文件核安全设备版.docx` —— 由用户手动选择？还是由某个“设备类别/项目类别”自动推断？
- 答复：由用户通过前端网页选择。  （后续可能会改成依据子项号自动选择）
2. **通用封面右上角字段**：通用封面是否也需要动态写入 `密级/状态/版次` 等？（1818 模板明确有 Rev/Status/Classification）  
- 答复：需要动态写入。封面内嵌的excel中几乎所有内容都需要动态写入。
3. **`catalog_no`（目录编号）来源**：是用户输入？还是由 `album_code` 推导？是否有固定格式？
- 答复：你说的目录编号是指什么我看不懂，请落实到具体哪个文件的哪一格。  
4. **目录排序规则**：默认按 `drawing_no` 还是按 `file_code`？是否需要按“专业/阶段/册次”分组？ 
- 答复：规则是按照“内部编码” 进行排序。
5. **设计文件/IED 的必填字段策略**：哪些列必须填、哪些可空、哪些需要“规则/映射表”生成？（否则落地开发时会不断返工）  
- 答复：我将在后续的文档中给出具体的字段策略。
6. **PDF 输出是否强制**：封面/目录/设计文件/IED 的 PDF 是必需还是可选？（影响 `pdf_engine` 与执行时机）
- 答复：是必须的，同时关于dxf文件的PDF打印，我还需要特别说明,我还需要设置上下左右四个边的页边距，这里需要额外处理。

---

## 1) 输入/输出接口（建议作为后端稳定 API）

### 1.1 输入对象：`DocContext`

- **job 维度**
  - `project_no: str`（项目号，用户前端输入，如 `1818/2016/2035`；用于模板分支与词库列选择）
  
  - `job_id: str`
  - `options: DocOptions`（是否生成封面/目录/设计文件/IED、PDF引擎等）
- **用户输入（全局字段）**
  - `user_params: GlobalDocParams`
- **图纸清单（逐张图）**
  - `frames: list[FrameMeta]`
- **聚合字段（由 frames 统计/推导）**
  - `aggregates: Aggregates`
- **规则与映射（可版本化）**
  - `rules: DocRules`
- **模板选择**
  - `templates: TemplateSelection`

### 1.2 输出对象：`DocArtifacts`

- `cover_docx, cover_pdf?`
- `catalog_xlsx, catalog_pdf?`
- `design_xlsx, design_pdf?`
- `ied_xlsx, ied_pdf?`（可选）
- `manifest.json`（推荐：记录模板版本、输入参数、推导字段、生成日志摘要、产物路径）

---

## 2) 参数分层（避免“全局字段 vs 每张图字段”互相覆盖）

### 2.1 `DocOptions`（控制是否生成与导出）

| Key | 含义 | 类型 | 默认 |
|---|---|---:|---|
| `generate_cover` | 生成封面 | bool | true |
| `generate_catalog` | 生成目录 | bool | true |
| `generate_design_file` | 生成设计文件 | bool | true |
| `generate_ied` | 生成 IED 计划 | bool | true（可配置关） |
| `export_pdf` | 是否导出 PDF | bool | true（可配置） |
| `pdf_engine` | Word/Excel → PDF 引擎 | enum | `office_com`（优先） / `libreoffice`（备选） |

> 注意：封面 docx 为“Word 内嵌 Excel(OLE)”结构；若要稳定刷新 OLE，优先使用 **Office COM**。

### 2.2 `GlobalDocParams`（用户输入，全局字段）

| Key | 中文含义 | 类型 | 必填 | 备注 |
|---|---|---:|:---:|---|
| `project_no` | 项目号 | str | 是 | 选择模板分支（1818 / 非 1818） |
| `engineering_no` | 工程号 | str | 建议是 | 封面/目录/设计/IED |
| `item_no` | 子项号/系统号 | str | 建议是 | 封面/目录/设计/IED |
| `item_name` | 子项/系统名称 | str | 建议是 | 封面/设计/IED |
| `design_phase` | 设计阶段 | str | 建议是 | 封面/设计/IED |
| `discipline` | 专业（中文或简称） | str | 建议是 | 封面/设计；目录可用 |
| `album_title` | 图册/文件名称（册名） | str | 视业务 | 封面、目录标题、ZIP 命名 |
| `album_code` | 图册/文件编号（文档号） | str | 视业务 | 封面右上角、目录文件编号、设计文件所属图册编码、IED |
| `catalog_no` | 目录编号 | str | 否 | **待你确认规则** |
| `album_seq` | 图册(文件)序号（册序） | str | 否 | 用于封面 `I25`（通用/1818） |
| `volume_index` | 第几册 | int | 否 | 生成封面“第X册” |
| `volume_total` | 共几册 | int | 否 | 生成封面“共X册” |
| `revision` | 版次/Rev. | str | 否 | 目录/设计/IED；1818 封面也需要 |
| `doc_status` | 状态/Status | str | 否 | 1818 封面需要；目录/设计/IED可复用 |
| `classification` | 密级/Classification | str | 否 | 设计文件/IED 明确有“密级”列；封面位置待确认 |
| `approved_by` | 批准人 | str | 否 | 封面 |
| `output_locale` | 输出语言 | enum | 否 | `cn` / `cn_en`（1818 双语） |

### 2.3 `FrameMeta`（每张拆分图纸字段）

| Key | 含义 | 类型 | 备注 |
|---|---|---:|---|
| `frame_id` | 图框实例ID | str | 后端生成 |
| `source_file` | 来源 DWG | str | 追溯 |
| `drawing_no` | 图纸编号（目录 B/C） | str | 图签/规则 |
| `file_code` | 文件编码（目录 D；设计文件 D；IED G） | str | 图签/规则 |
| `title_cn` | 中文标题（目录 E；设计文件 G；IED K） | str | 图签/规则 |
| `title_en` | 英文标题（1818/IED/设计文件 H/L） | str | 可空 |
| `paper_size` | 图幅（设计文件 S） | str | 图幅模板/图签 |
| `scale_text` | 比例文本 | str | 图签 |
| `revision` | 版次 | str | 图签/全局覆盖 |
| `status` | 状态 | str | 图签/全局覆盖 |
| `design_phase` | 设计阶段 | str | 图签/全局覆盖 |
| `discipline` | 专业 | str | 图签/全局覆盖 |
| `page_count` | 页数（目录 H；设计文件 T） | int | 默认 1 |
| `remarks` | 附注（目录 I） | str | 可空 |
| `pdf_path` | 该张图 PDF 路径 | str | 回填 |
| `dwg_path` | 该张图 DWG 路径 | str | 可选回填 |

---

## 3) 字段优先级与覆盖约定（强烈建议固化）

对同名字段（如 `discipline/design_phase/revision/status`）按以下优先级取值：

1. **FrameMeta**（每张图图签/模板提取值，且通过校验）
2. **GlobalDocParams**（用户输入全局值）
3. **rules.defaults**（系统默认值）

并在 `manifest.json` 输出“字段来源报告”（可选但强烈推荐）：
- `field -> source(frame/global/default) -> value`
- 缺失/不合法字段清单（用于前端提示）

---

## 4) 模板体系与选择规则（已扫描确认的事实）

### 4.1 封面模板（docx，均包含 1 个嵌入的 Excel Worksheet）

- `封面模板文件.docx`（通用）
- `封面模板文件压力容器版.docx`（通用变体）
- `封面模板文件核安全设备版.docx`（通用变体）
- `1818图册封面模板.docx`（1818 专用）

> 上述 4 个 docx 文件都包含 `word/embeddings/Microsoft_Excel_Worksheet.xlsx`，因此导出 PDF 推荐 `office_com`。

**模板选择（建议）**
- `project_no == "1818"`：固定使用 `1818图册封面模板.docx`
- 否则：使用 `cover_variant` 选择三套通用封面之一（**待你确认规则**）

### 4.2 目录模板（xlsx）

- 通用：`目录模板文件.xlsx`（Sheet1/2/3；主要用 Sheet1）
- 1818：`1818图册目录模板.xlsx`（Sheet1/2/3；主要用 Sheet1；且 `C1` 预填 `1818`）

**结构确认**
- 目录表头为两行（第 7~8 行），数据从 **第 9 行**开始写。
- `B列与C列`为合并单元格（模板内大量存在 `B{row}:C{row}` 合并区，已扫描确认）。

### 4.3 设计文件模板（xlsx）

- `设计文件模板.xlsx` / Sheet `设计文件模板`
- **表头在第 1 行，共 26 列（A~Z），已扫描确认**

### 4.4 IED 计划模板（xlsx）

- `IED计划模板文件.xlsx` / Sheet `IED导入模板 (修改)`
- **表头在第 1 行，共 66 列（A~BN），已扫描确认**（见第 8 节）

---

## 5) 封面（Cover）参数与落点（docx 内嵌 Excel(OLE)）

> 说明：封面模板为 docx + 内嵌 Excel(OLE)；实际填写发生在嵌入的 worksheet 上。  
> 下表的“单元格坐标”来自你当前模板约定（后续如有变更，以模板扫描/人工确认更新为准）。

### 5.1 通用封面（`封面模板文件*.docx`，内嵌 Sheet“封面”）

| Key | 含义 | 写入单元格（值位） | 备注 |
|---|---|---|---|
| `engineering_no` | 工程号 | `I11` | 标签 `D11` |
| `item_no` | 子项号/系统号 | `I13` | 标签 `D13` |
| `item_name` | 子项/系统名称 | `I15` | 标签 `D15` |
| `design_phase` | 设计阶段 | `I17` | 标签 `D17` |
| `discipline` | 专业 | `I19` | 标签 `D19` |
| `album_title` | 图册(文件)名称 | `I21` | 标签 `D21` |
| `album_seq` | 图册(文件)序号（册序） | `I25` | 标签 `D25` |
| `approved_by` | 批准 | `I27` | 标签 `D27` |
| `album_code` | 图册（文件）编号 | `N3` | 标签 `N2`；值位 `N3:S3`（合并区） |
| `volume_total` + `volume_index` | 共X册 第Y册 | `N4` | 直接写入整句：`共2 册      第1 册` |

> 预留：通用封面是否需要额外写入 `classification/revision/doc_status` 等右上角字段（待你确认）。

### 5.2 1818 封面（`1818图册封面模板.docx`，内嵌 Sheet“封面”）

| Key | 含义 | 写入单元格（值位） | 备注 |
|---|---|---|---|
| `engineering_no` | 工程号/Project No. | `I10` | 标签 `D10/D11` |
| `item_no` | 子项号/Item No. | `I12` | 标签 `D12/D13` |
| `item_name` | 子项名称/Item Name | `I14` | 标签 `D14/D15` |
| `design_phase` | 设计阶段/Design Phase | `I16` | 标签 `D16/D17` |
| `discipline` | 专业/Discipline | `I18` | 标签 `D18/D19` |
| `album_title` | 文件名称/Document Title | `I20` | 标签 `D20/D21` |
| `album_seq` | 文件序号/Document No.（册序） | `I25` | 标签 `D25/D26` |
| `approved_by` | 批准/Approved by | `I27` | 标签 `D27/D28` |
| `album_code` | Document No.（右上角） | `M3` | 标签 `M2`；值位 `M3:S3`（合并区） |
| `volume_total` + `volume_index` | Vol. x of y | `M4` | 例如：`Vol. 1 of 3` |
| `revision` | Rev. | `M5` | 默认模板可能预填，可覆盖 |
| `doc_status` | Status | `P5` | 默认模板可能预填，可覆盖 |
| `classification` | Classification | （待定） | 模板存在标签，值位需你确认 |

---

## 6) 目录（Catalog）参数与落点

### 6.1 通用目录（`目录模板文件.xlsx` / Sheet1）

**页眉字段（建议落点保持与现模板一致）**

| Key | 含义 | 单元格（建议） | 备注 |
|---|---|---|---|
| `engineering_no` | 工程号 | `C1` | 标签 `A1` |
| `catalog_no` | 编号 | `H1` | 模板为合并区（常见为 `H1:I1`，以模板为准） |
| `album_code` | 文件编号 | `H3` | 标签 `F3` |
| `item_no` | 子项号 | `C5` | 标签 `A5` |
| `revision` | 版次 | `H5` | 标签 `G5` |

> 说明：扫描显示这些单元格在模板里多为空（作为填写位），因此生成时直接写入即可。

**目录明细（从第 9 行开始）**

| 列 | 含义 | 来源 |
|---:|---|---|
| A | 序号 | 自动递增 |
| B/C | 图纸（文件）编号 | `FrameMeta.drawing_no` |
| D | 文件编码 | `FrameMeta.file_code` |
| E | 图纸（文件）名称 | `FrameMeta.title_cn`（或规则拼接） |
| F | 版次 | `FrameMeta.revision` / 全局 |
| G | 状态 | `FrameMeta.status` / 全局 |
| H | 页数 | `FrameMeta.page_count`（默认 1） |
| I | 附注 | `FrameMeta.remarks` |

### 6.2 1818 目录（`1818图册目录模板.xlsx` / Sheet1）

**页眉字段**

| Key | 含义 | 单元格（模板扫描确认的合并区） |
|---|---|---|
| `engineering_no` | Project No. | `C1`（模板预填 1818，可覆盖） |
| `catalog_no` | Document No. | `H1`（合并 `H1:I2`） |
| `album_code` | Document Code | `H3`（合并 `H3:I4`） |
| `item_no` | Item No. | `C5`（合并 `C5:C6`） |
| `revision` | Rev. | `H5`（合并 `H5:H6`） |

明细区写入规则同通用模板。

---

## 7) 设计文件（Design File）参数与落点（A~Z，已扫描确认）

模板：`设计文件模板.xlsx` / Sheet `设计文件模板`  
数据从第 2 行开始，每张图一行。

| 列 | 表头 | 参数Key（建议） | 推荐来源 |
|---:|---|---|---|
| A | 状态 | `design.status` | 规则/默认（需你定枚举） |
| B | WBS编码 | `design.wbs_code` | 规则/映射（需你提供规则或映射表） |
| C | 所属图册编码 | `album_code` | 全局/规则 |
| D | 文件编码 | `file_code` | FrameMeta |
| E | 内部编码 | `design.internal_code` | 规则/可空 |
| F | 版本 | `revision` | FrameMeta/全局 |
| G | 中文标题 | `title_cn` | FrameMeta |
| H | 英文标题 | `title_en` | FrameMeta/可空 |
| I | 内部标识 | `design.internal_tag` | 规则/可空 |
| J | 子项名称 | `item_name` | 全局/规则 |
| K | 子项号 | `item_no` | 全局/规则 |
| L | 系统代码 | `design.system_code` | 规则/可空 |
| M | 系统名称 | `design.system_name` | 规则/可空 |
| N | 专业(工种) | `discipline` | FrameMeta/全局 |
| O | 专业代码 | `design.discipline_code` | 映射表（需你给“专业→代码”） |
| P | 专业室 | `design.discipline_office` | 映射表/可空 |
| Q | 设计阶段 | `design_phase` | FrameMeta/全局 |
| R | 密级 | `classification` | 全局/规则 |
| S | 图幅 | `paper_size` | FrameMeta |
| T | 总页数 | `page_count` | FrameMeta |
| U | 文件类别 | `design.file_category` | 规则/映射（模板含 sheet“文件类别”可参考） |
| V | 图纸文件状态 | `design.drawing_status` | 规则/映射 |
| W | 附件名称 | `design.attachment_name` | 可空 |
| X | 是否质保核查 | `design.qa_required` | 规则/默认 |
| Y | 质保核查工程师 | `design.qa_engineer` | 规则/可空 |
| Z | 实际工时数 | `design.actual_hours` | 可空（数值） |

---

## 8) IED 导入表（IED计划）参数与落点（A~BN，共 66 列，已扫描确认）

模板：`IED计划模板文件.xlsx` / Sheet `IED导入模板 (修改)`  
表头第 1 行（A~BN）为：

- A 新增标记
- B 变更标记
- C 文档类型
- D IED状态
- E WBS编码
- F 所属图册/文件编码
- G 文件编码
- H 原文件编码
- I 内部编码
- J 版本
- K 中文标题
- L 英文标题
- M 人员资格类别
- N 所提交计划
- O 计划会签日期
- P 出版计划
- Q 外部计划
- R FU标记
- S FU计划
- T 计划调整依据
- U 内部标识
- V 设计类型
- W 责任设总
- X 责任单位
- Y 是否联合编审文件
- Z 章节号
- AA 章节名称
- AB SSC编码
- AC 是否更新SSC关联
- AD 机组
- AE 系统代码
- AF 安装厂房
- AG 安装层位及标高
- AH 安装区域
- AI 安装层位
- AJ 岛别
- AK 土建厂房代码
- AL 土建分区
- AM 土建层位及标高
- AN 土建区域
- AO 房间
- AP 模块
- AQ 设备代码
- AR 总体性文件
- AS 相关物项类别
- AT 计划工时
- AU 是否验证
- AV 验证方法
- AW 验证人
- AX 验证日期
- AY 编制者
- AZ 第二编制者
- BA 编制日期
- BB 校核者
- BC 校核日期
- BD 工种负责人
- BE 工种负责人审核日期
- BF 审核者
- BG 审核日期
- BH 审定者
- BI 审定日期
- BJ 专业室
- BK 密级
- BL 所提交计划原因
- BM 出版计划原因
- BN 外部计划原因

> 建议落地策略（避免一次性把 66 列都“强必填”）：  
> - **第一期只强制**：`文档类型/IED状态/WBS编码/所属图册或文件编码/文件编码/内部编码/版本/中文标题`（其余可留空或走规则默认）。  
> - 第二期再逐步补齐：安装/土建/SSC/校审链条等字段（通过映射表或业务规则生成）。

---

## 9) 规则与映射（建议作为可版本化配置，而不是硬编码）

### 8.1 `DocRules.defaults`
- 默认 `revision/doc_status/classification/page_count` 等

### 8.2 `DocRules.catalog_sort`
- `by_drawing_no` / `by_file_code` / `custom`

### 8.3 `DocRules.mappings`
- `discipline -> discipline_code / discipline_office`
- `file_category`（可参考 `设计文件模板.xlsx` 的 sheet `文件类别`）
- `design_type`（可参考 `责任单位/ACP1000设计类型/AP1000设计类型` 等 sheet）

---

## 10) 模板切换规则（已确定 + 待确认项）

**已确定**
- `project_no == "1818"`：使用 `1818图册封面模板.docx` + `1818图册目录模板.xlsx`
- 否则：使用通用目录 `目录模板文件.xlsx`

**待你确认**
- 非 1818 的封面：通用/压力容器/核安全设备版如何选择（建议引入 `cover_variant`）


