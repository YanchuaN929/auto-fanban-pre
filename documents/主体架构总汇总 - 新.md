## 内网 Web + Python 后端的 DWG 批处理系统：主体架构总汇总（用于投喂新 AI 开发）

> **目标**：在公司内网（无互联网）环境中，用户通过浏览器上传 DWG（可多文件），后端离线批处理完成：
> `DWG→DXF → 识别图框 → 图签字段提取 →（A4多页成组）→ 拆分/裁切 → 重命名 → 输出PDF →（可选）DXF→DWG → 生成封面/目录/设计文件/IED计划 → 导出PDF → 打包ZIP`  
> 并提供“词库检查/替换（纠错/翻版）”能力。
>
> **硬约束**：
> - **DXF 仅作为中间文件**，不对用户输出。
> - 首版可跳过字段/XREF（外部参照），不追求完全保真，但需支持 **多图幅、多比例混排**。
> - 文档（封面/目录/设计文件/IED）**必须导出 PDF**。
>
> **配置源事实（权威）**：`documents/参数规范.yaml`（v2.0）  
> **可读说明（辅助）**：`documents/参数表.md`、`documents/A4特殊逻辑.md`

---

## 1) 阅读导航（新 AI 先看这些）

- **`documents/参数规范.yaml`**：唯一权威的结构化规范，包含：
  - `doc_generation`：封面/目录/设计文件/IED 生成参数、派生规则、模板落点、目录分页计页策略
  - `titleblock_extract`：DXF 图框识别 + rb_offset ROI + 字段解析规则
  - `a4_multipage`：A4 多页说明图（001）成组处理规则
- **`documents/参数表.md`**：把 doc_generation 的字段/列落点写成表格，便于人审。
- **`documents/A4特殊逻辑.md`**：A4 多页规则的“解释版/推导版”，用于实现细节理解（与 YAML 的 `a4_multipage` 需保持一致）。
- **`documents/工具列表.yaml`**：tools 目录脚本用途与保留/删除建议汇总，便于复用或清理。
- **模板与静态数据**：
  - 模板目录：`documents_bin/`（封面 docx、目录/设计/IED xlsx）
  - IED 下拉候选：`documents_bin/responsible_unit.json`

---

## 2) 两条流水线（必须支持）

### 2.1 流水线 A：交付包生成（核心）

**输入（Web 上传）**
- 1 个或多个 `.dwg`
- `project_no`（项目号，用于模板分支/词库列）
- `doc_generation.options`（是否生成、PDF、页边距等；详见 `documents/参数规范.yaml`）
- `doc_generation.params.*`（前端输入/选择；详见 `documents/参数规范.yaml`）

**输出（下载）**
- 单个 `package.zip`（交付包）
  - 拆分后的图纸产物（PDF，及可选 DWG）
  - 封面：docx + pdf
  - 目录：xlsx + pdf
  - 设计文件：xlsx + pdf
  - IED计划：xlsx + pdf（当前按规范“始终生成并输出”）
  - `manifest.json`（机器可读清单：输入、派生、落点、告警 flags、生成日志摘要）

### 2.2 流水线 B：词库检查/替换（质检/批改）

**名词约定**
- “纠错”：只做检查输出报告
- “翻版”：执行替换（可能把 `1916 → 2016` 等项目相关文本替换为目标项目）

**输入**
- `.dwg`（通过ODA File Converter转换为`.dxf`）
- `project_no`（选择词库列）
- 词库 Excel：`documents_bin/词库收集.xlsx`

**输出**
- 检查报告（Excel/CSV/JSONL）
- 可选：替换后的结果文件（DWG/PDF 对比）

**关键约束（避免误伤）**
- 高风险短串（如纯 4 位数字项目号）默认 **仅在图签 ROI 范围内替换**；全局替换必须显式开关 + dry-run 报告。
- 不展开 XREF 内容（首版）。

---

## 3) 关键数据结构（对外 API + 内部中间结构）

### 3.1 Job（任务）
- `job_id`：UUID
- `job_type`：`deliverable` | `audit_replace`
- `project_no`
- `inputs[]`：上传文件清单（DWG/词库/参数）
- `options`：`doc_generation.options` + 运行参数（并发数等）
- `status`：`queued/running/succeeded/failed/cancelled`
- `progress`：0~100（阶段化）
- `artifacts`：产物路径（zip、报表等）
- `manifest.json`：清单（建议强制输出）

### 3.2 FrameMeta（单个图框实例）
以 `documents/参数规范.yaml` 的 `doc_generation.frame_meta` 为准，拆成两层：
- **运行期字段（DXF流水线产物）**：`frame_id/source_file/paper_variant_id/sx/sy/geom_scale_factor/roi_profile_id/scale_mismatch/flags/pdf_path/dwg_path/...`
- **图签字段（titleblock，来自 DXF ROI 提取）**：`internal_code/external_code/engineering_no/subitem_no/paper_size_text/discipline/scale_text/page_total/page_index/title_cn/title_en/revision/status/date`

### 3.3 Sheet-Set（A4 多页说明图 001 成组单元）
以 `documents/参数规范.yaml:a4_multipage.result_structure.example` 与 `documents/A4特殊逻辑.md` 为准：
- `cluster_id/page_total/master_page/pages[]/flags[]`
- 输出偏好：**多页 PDF**（每个 A4 外框一页，按 `page_index` 排序）

### 3.4 DocContext（文档生成上下文）
文档生成模块只消费结构化数据：
- `project_no`
- `doc_generation.options`
- `doc_generation.params`（按“前端输入/图签提取/派生”合成）
- `frames[]`（以及 A4 sheet-set 的归并结果）
- `rules/mappings`（来自 YAML 中 `doc_generation.rules`）

---

## 4) 配置与“源事实”原则（非常重要）

### 4.1 单一真相源
- **`documents/参数规范.yaml` 是唯一权威**：前端表单/后端校验/生成 manifest/模板填充都应以它为准。
- `documents/参数表.md` 只用于人读，但必须与 YAML 同步（避免“文档和实现分叉”）。

### 4.2 变量来源的三类
以 `documents/参数规范.yaml:doc_generation.params` 字段的 `source` 为准：
- `frontend`：用户前端输入（通常全图册同值）
- `dxf:*`：从 `frames[].titleblock.*` 提取或从 001 图纸聚合
- `derived`：派生规则（例如封面/目录编码、目录版次、封面/目录标题等）

---

## 5) 流水线 A（交付包生成）——阶段化执行（建议实现）

### 5.1 推荐阶段（用于进度条/日志）
1. `INGEST`：落盘与校验（DWG/参数/词库）
2. `CONVERT_DWG_TO_DXF`：调用 ODA File Converter
3. `DETECT_FRAMES`：DXF 解析、候选外框识别（闭合 polyline 优先，LINE 重建兜底）
4. `VERIFY_FRAMES_BY_ANCHOR`：锚点 ROI 验证（CNPE/中国核电工程有限公司）
5. `SCALE_FIT_AND_CHECK`：纸张尺寸拟合输出 `paper_variant_id/sx/sy`，并做比例一致性检查（不中断，写 flags）
6. `EXTRACT_TITLEBLOCK_FIELDS`：按 ROI profile 提取字段并解析（内外部编码/标题/张数/版次/状态等）
7. `A4_MULTIPAGE_GROUPING`：对 A4 多页说明图（001）做簇聚类与 Master/Slave 识别
8. `SPLIT_AND_RENAME`：按图框裁切/拆分成子图（保持坐标不归零），重命名
9. `EXPORT_PDF_AND_DWG`：输出子图 PDF（按图幅/页边距）；可选 DXF→DWG
10. `GENERATE_DOCS`：封面/目录/设计文件/IED 生成与导出 PDF
11. `PACKAGE_ZIP`：打包交付包 + 输出 manifest

### 5.2 失败隔离策略
- 单图（frame）失败不影响全局：记录到 `manifest.flags/errors`，继续后续图框。
- 所有一致性问题（比例不一致/A4页数不一致/缺页等）**只打 flags，不中断**（见 `a4_multipage.policy`）。

---

## 6) 文档生成模块（doc_generation）——实现要点（必须落到代码里）

> 权威规则见：`documents/参数规范.yaml:doc_generation`

### 6.1 生成选项（doc_generation.options）
- `enabled`: true 时 **封面/目录/设计文件/IED 全部生成**
- `export_pdf`: 必须 true
- `pdf_engine`: `office_com` 优先（含 OLE 时更可靠），`libreoffice` 备选
- `pdf_margin_mm`: DXF 打印 PDF 页边距（四边）

### 6.2 模板选择（templates.selection）
- `project_no == "1818"`：使用 `1818图册封面模板.docx` + `1818图册目录模板.xlsx`
- 否则：使用通用模板；封面由 `cover_variant` 三选一（通用/压力容器/核安全设备）

### 6.3 核心派生规则（doc_generation.derivations）
必须按规范实现（避免硬编码散落）：
- 以 001 图纸为基准派生：
  - `album_internal_code = strip_suffix(internal_code_001, '-001')`
  - `album_code = extract_mid5_last2(internal_code_001)`
  - `cover_internal_code = replace_suffix(internal_code_001, '-FM')`
  - `catalog_internal_code = replace_suffix(internal_code_001, '-TM')`
  - `cover_external_code / catalog_external_code`：外部编码第 9~11 位替换为 `F01/T01`
- 标题派生（封面/目录行）：
  - `cover_title_cn/catalog_title_cn = album_title_cn + '封面/目录'`
  - `cover_title_en/catalog_title_en`（仅 1818）
- 目录版次：
  - `catalog_revision = coalesce_nonempty(upgrade_revision, cover_revision)`
- 目录页数：
  - `catalog_page_total = count_pdf_pages(catalog_pdf)`（见 6.5）

### 6.4 封面生成（Word 内嵌 Excel OLE）
- 模板为 docx + 内嵌 Excel(OLE)；写入点见 `doc_generation.templates.cover_bindings`。
- `cover_revision` 采用 **增量追加**（例如在 “版次：/Rev.:” 后追加）。
- 外部编码 `cover_external_code` 按模板事实写入：第 29 行 `B..T` 连续 19 个格（逐字符写入）。
- 导出 PDF：优先 Office COM（刷新 OLE 更稳定）。

### 6.5 目录生成（Excel）与“导出PDF计页”算法（关键）
目录模板事实与落点见 `doc_generation.templates.catalog_bindings`：
- 明细区从第 9 行开始写；行顺序固定：
  - 第 1 行：封面
  - 第 2 行：目录
  - 其余：`001~XXX` 图纸，按 `internal_code` 尾号 `XXX` 升序
- **1818 的名称列特殊**：同一单元格写 `title_cn + '\n' + title_en`，必须启用 `WrapText` 并处理行高（会影响分页）

**目录页数（catalog_page_total）实现策略（必须按 PDF 计页）**
1. 先按规则生成目录 xlsx（包含所有明细行）
2. 动态设置打印区域（`Print_Area/Print_Titles`），导出 PDF
3. 统计 PDF 页数（`catalog_page_total`）
4. 回填目录行的 `H` 列（目录文件那一行的页数），再二次导出 PDF，确保 xlsx 与 pdf 一致

### 6.6 设计文件（Excel）与 IED 计划（Excel）
落点与来源规则按 `doc_generation.templates.design_bindings` 与 `doc_generation.templates.ied_bindings`：
- **全局同值字段**：用户前端输入一次，写入所有行（例如 `wbs_code/work_hours/classification/...`）
- **图纸行字段**：从 `frames[].titleblock.*` 读取
- **封面/目录行特化**：内部/外部编码、标题、页数等用派生字段

IED 关键点：
- IED 表的列集合很大，但当前规范明确了：
  - A 固定 `'A'`（新增标记）
  - 多列固定空值（Z~AS、AU~AX、BL~BW 等）
  - `ied_discipline_office` 由 `responsible_unit.json` 的完整路径取最后一个 `-` 后缀文本
- 工时字段已统一：`work_hours` 同值写入 **设计文件 Z** 与 **IED AT**

---

## 7) 图签提取模块（titleblock_extract）——实现要点

> 权威规则见：`documents/参数规范.yaml:titleblock_extract`

### 7.1 处理流水线（5 步）
`dwg_to_dxf → frame_detect → frame_verify(anchor) → scale_check → field_extract`

### 7.2 ROI 坐标系与还原
- 坐标系：`rb_offset_scaled`（相对外框右下角，按 `sx/sy` 缩放）
- 还原公式见 `titleblock_extract.principles.rb_offset_formula/roi_restore_formula`

### 7.3 纸张拟合与 ROI profile
- 标准图幅见 `paper_variants`（A0~A4，含变体）
- ROI profiles：
  - `BASE10`（大图幅）
  - `SMALL5`（A3/A4 小图幅）

### 7.4 字段解析规则（field_definitions）
必须支持：
- `external_code`：固定 19 位（`DOC.NO`）
- `internal_code`：两种格式（带 `-XXX` 或短格式），并能从 `mid` 提取 `album_code`
- `page_info`：支持整句与 token 解析（`共N张 第M张`，M 可为 X/x）
- `title`：中英文分流（按 y 聚类成行；含 CJK 的行归中文；纯英文/数字归英文）
- `revision/status/date`：列内取 y 值最大的文本（pick_top_by_y）

### 7.5 质量与不中断策略
- 比例不一致：写 `flag_name="比例不一致"`，继续运行
- 容差：`tolerances` 段统一管理（ROI margin、y 聚类、比例容差等）

---

## 8) A4 多页说明图（001）成组处理（a4_multipage）

> 解释版见：`documents/A4特殊逻辑.md`  
> 配置版见：`documents/参数规范.yaml:a4_multipage`

### 8.1 触发条件
- 同一 DXF 检测到 ≥2 个 A4 外框属于同一簇（cluster）
- 簇内存在至少 1 个 Master Page（锚点命中 + 关键字段命中数≥3）

### 8.2 核心算法摘要
- A4 判定：外框拟合到 210×297 或 297×210（允许任意缩放，误差 ≤ 2%）
- Cluster 构建：按外框间距连边取连通分量
- Master 选择：字段命中最多，或能解析 `page_total` 且 `page_index=1`
- Slave 页码：右上角固定 ROI 优先，失败则位置评分兜底
- 一致性检查：页数不一致/缺页/重复/冲突 → flags，不中断
- 输出：优先多页 PDF；失败兜底单页大图 PDF（写 flag）

---

## 9) 后端模块拆分（建议的 Python 结构）

> 目标：让“配置（YAML）/算法（CAD）/模板写入（Office）/任务编排（Job）”清晰解耦。

```text
repo/
  backend/
    app/
      main.py
      api/
        jobs.py
        upload.py
        download.py
      services/
        job_manager.py
        storage.py
        oda_converter.py          # DWG↔DXF
        dxf_reader.py             # ezdxf 解析与通用文本归一化
        frame_detector.py         # 外框候选 + 几何拟合
        titleblock_extract.py     # anchor/roi_restore/field_parse
        a4_multipage.py           # sheet-set 聚类/页码识别/一致性检查
        splitter.py               # 裁切/拆分（保持坐标）
        pdf_exporter.py           # 子图 PDF 输出（含页边距）
        doc_generation/
          spec_loader.py          # 读取 documents/参数规范.yaml
          cover.py
          catalog.py
          design.py
          ied.py
          pdf_engine.py           # office_com/libreoffice
        lexicon/
          audit.py
          replace.py
        packager.py              # ZIP + manifest
      models/
        job.py
        frame.py
        doc_context.py
```

---

## 10) API（最小可用）

### 10.1 创建交付包任务（流水线 A）
- `POST /api/jobs/deliverable`
  - form-data：`dwg_files[]` + `project_no` + `doc_generation.options/params`（JSON）
  - 返回：`job_id`

### 10.2 创建检查/替换任务（流水线 B）
- `POST /api/jobs/audit-replace`
  - form-data：`dwg_files[]` + `project_no` + `lexicon.xlsx`
  - 可选：`mode=check|replace`
  - 返回：`job_id`

### 10.3 查询任务状态
- `GET /api/jobs/{job_id}`
  - 返回：状态、进度、阶段、错误信息、产物列表

### 10.4 下载产物
- `GET /api/jobs/{job_id}/download`（交付包 ZIP）
- `GET /api/jobs/{job_id}/artifacts/{name}`（单个报表/单个 PDF，可选）

---

## 11) 运行与部署（内网 Windows 单机）

### 11.1 依赖
- ODA File Converter（DWG↔DXF）（路径需可配置）
- Office（用于 `office_com` 导出 PDF，尤其是封面 OLE）
- Python 环境（建议使用 venv）

### 11.2 路径与权限
- 任务目录建议放在本机可写盘（避免共享盘权限问题）
- 中间 DXF 仅保存在 job 工作目录，不对外输出

---

## 12) 产物目录结构建议（每 job 一套）

```text
storage/jobs/{job_id}/
  input/
  work/
    dxf/
    frames/               # 每个 frame 的中间结果
    a4_sheet_sets/
  output/
    drawings/             # 拆分后的 PDF /（可选）DWG
    docs/                 # cover/catalog/design/ied + pdf
    reports/
  manifest.json
  logs/job.log
  package.zip
```

---

## 13) 日志与可观测性（必须做）
- `logs/job.log`：阶段日志 + 外部程序调用（ODA/Office）stdout/stderr
- `reports/frame_results.jsonl`：每个 frame 的 bbox、paper_variant、roi_profile、提取字段、flags
- `manifest.json`：记录“字段来源”（frame/global/default/derived）与最终写入值（便于前端提示缺失项）

---

## 14) 开发顺序建议（按风险从高到低）
1. Job 框架（FastAPI + 本地队列/worker + 存储目录 + 状态查询 + 下载）
2. ODA 转换（DWG→DXF）
3. 最小图框识别 + 锚点验证（能稳定抓到图签区域）
4. 图签字段提取（internal/external/title/revision/status/page_info）
5. 拆分/裁切输出 + 子图 PDF（含页边距）
6. A4 多页成组（001 高频场景）
7. 文档生成（封面/目录/设计/IED）+ PDF 导出（Office COM 优先）
8. 词库检查/替换（先 check，再 replace；加误伤防护）
9. 打包 ZIP + manifest 完整闭环

---

## 15) 文件与模板清单（当前已知）
- 文档模板（`documents_bin/`）：
  - 通用封面：`封面模板文件.docx` / `封面模板文件压力容器版.docx` / `封面模板文件核安全设备版.docx`
  - 1818 封面：`1818图册封面模板.docx`
  - 通用目录：`目录模板文件.xlsx`
  - 1818 目录：`1818图册目录模板.xlsx`
  - 设计文件：`设计文件模板.xlsx`
  - IED：`IED计划模板文件.xlsx`
- 规则/规范：
  - `documents/参数规范.yaml`（v2.0，权威）
  - `documents/参数表.md`（可读说明）
  - `documents/A4特殊逻辑.md`（A4多页解释）
  - `documents_bin/responsible_unit.json`（IED 责任单位候选）

