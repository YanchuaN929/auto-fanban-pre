# 内网 Web + Python 后端的 DWG 批处理系统：主体架构总汇总（用于投喂新 AI 开发）

> 目标：在公司内网（无互联网）环境中，用户通过浏览器上传 DWG（可多文件），后端离线批处理完成“dwg转化dxf→识别图框→拆分→重命名→输出PDF与转换回dwg→生成封面/目录/设计文件→打包 ZIP”，并提供“词库检查/替换”能力。  
> 约束：DXF 仅作为**中间文件**，不对用户输出；首版跳过字段/外部参照（XREF）；不追求完全保真；支持多图幅、多比例混排。

---

## 1. 总体业务目标与两条流水线

### 1.1 流水线 A：交付包生成（核心）
**输入（Web 上传）**
- 1 个或多个 `.dwg`
- 可选：项目号、起点/终点项目号、命名规则参数、输出选项
- 可选：用于生成文档的参数表（后续你会补充）

**处理（后端）**
1. DWG → DXF（ODA File Converter）
2. DXF 解析：识别所有图框（一个 DWG 内可能 N 张图）
3. 按每个图框：
   - 读取右下角图签字段（图幅/比例/专业/张数等）
   - 裁切/拆分成独立子图（中间：子 DXF）
   - 重命名（按规则）
   - 输出子图 PDF（按图幅设置页面/自适应）
   - 子 DXF → 子 DWG（ODA）
4. 生成配套文档（该过程命名为“生成传图文件”）：
   - 封面：Word + PDF（模板按项目号切换）
   - 目录：Excel + PDF（模板按项目号切换）
   - 设计文件：Excel（通用模板，生成规则后续补充）
   - IED 计划：Excel，纳入交付包）
5. 将所有产物打包为 `package.zip` 供下载

**输出（下载）**
- 单个 ZIP（交付包），内部包含拆分后文件、PDF、封面/目录及其PDF、设计文件、IED计划
- 当开启翻版时，按照项目号和对应的词库，将所有识别到的文字，按照项目号进行全部替换，例如：1916翻版为2016。同时还需要一个子选项，是否输出传图文件。勾选时，将替换后的文件执行“生成传图文件”流程。

---

### 1.2 流水线 B：词库检查/替换（质检/批改）——这一检查过程即为“纠错”，替换过程即为“翻版”
**输入（Web 上传）**
- 1 个或多个 `.dwg`（或 `.dxf` 作为高级模式）
- 项目号（用于选择词库列）
- 词库 Excel：`词库收集.xlsx`

**处理（后端）**
1. DWG → DXF（如输入为 DWG）
2. 扫描所有文字对象：`TEXT / MTEXT / ATTRIB / 块内文字`
3. 按项目号词库对照表做：
   - 检查（命中项统计、位置、对象类型、原文）
   - 可选替换（需严格策略避免误伤短串，如 4 位项目号）
4. 输出检查报告 +（可选）替换结果文件（通常为 DWG 或 PDF 对比；DXF 仍不直接输出）

**输出（下载）**
- 检查报告（Excel/CSV/JSONL）
- 可选：替换后的结果文件（DWG/PDF）

---

## 2. 部署与运行形态（内网单机提供服务）

- 你在自己电脑/一台工作站上启动**前端 + 后端**（同机部署），其他用户通过内网浏览器访问 URL 使用。
- 采用“上传→后端本机处理→下载 ZIP”模式时，**不依赖共享盘权限**。


---

## 3. 技术栈建议（离线可部署）

### 3.1 后端
- Python 3.13
- Web 框架：FastAPI + Uvicorn
- 任务队列：
  - MVP：本地队列 + 多进程 worker（SQLite 记录状态）
  - 进阶：RQ（Redis）或 Celery（Redis/RabbitMQ）
- CAD 处理：
  - ODA File Converter（DWG↔DXF），作为外部可执行程序，本地安装路径：“E:\Program Files\ODA\ODAFileConverter 26.10.0\ODAFileConverter.exe”
  - `ezdxf`：读取/修改 DXF（TEXT/MTEXT/ATTRIB/块定义）
- PDF 导出：
  - `ezdxf` drawing add-on + `PyMuPDF`（推荐）或 Matplotlib（这里备选，需要你考虑一下到底选哪个）
- 文档生成：
  - Word：`python-docx`
  - Excel：`openpyxl`
  - Word/Excel → PDF：
    - 优先：Windows + Office COM（稳定，能刷新 OLE）
    - 备选：LibreOffice headless（无需 Office，但对 OLE 刷新不一定可靠）

### 3.2 前端
- 简化方案：服务端模板（Jinja2）或轻量 SPA（React/Vue 均可）是否使用CSS样式，需要你考虑一下。因为我希望可以简洁美观
- 核心能力：上传、参数选择、任务列表、进度、下载

---

## 4. 关键产品规则与约束（必须落到代码里）

### 4.1 DXF 不对外输出
- DXF 仅在后端 `work/` 目录中存在，用于解析/拆分/替换。
- 交付包默认只输出：DWG（可选）、PDF、Word/Excel/PDF、报表、ZIP。


### 4.2 考虑检查所有可能得文字对象
- 字段
  - 替换/检查作用于所有可能的文字对象，例如：TEXT、MTEXT、ATTRIB、块内文字等
  - 但不展开外部参照内容

### 4.3 避免误伤：短串项目号不可全局替换
- 例如 `2016` 可能与埋件编号 `2016PPxx` 冲突。
- 替换策略（建议默认）：
  - 高风险短串（纯 4 位数字、两位代号）仅在图签字段范围内替换
  - 低风险长串可全局替换（仍建议做层/块过滤或 dry-run 报告）

---

## 5. 数据模型（对外 API 的稳定接口）

### 5.1 Job（任务）主模型
- `job_id`：UUID
- `job_type`：`deliverable` | `audit_replace`
- `project_no`：如 `1818`
- `inputs`：上传文件清单（dwg/excel）
- `options`：用户参数（并发数、是否输出 dwg、是否生成文档等）
- `status`：`queued/running/succeeded/failed/cancelled`
- `progress`：0~100（阶段化）
- `artifacts`：输出文件路径（zip、报表等）
- `manifest`：机器可读清单（JSON）

### 5.2 Frame（单个图框实例）模型（拆分与命名的核心）
- `source_dwg` / `source_dxf`
- `frame_id`
- `bbox`：`minx,miny,maxx,maxy`（世界坐标）
- `template_id`：匹配到的图幅模板（15 种之一）
- `scale_factor`：相对模板的几何缩放倍数
- `titleblock_meta`：图签字段字典（图幅/比例/专业/张数/图号/图名…）
- `outputs`：该图框拆分产物（dwg/pdf/…）

### 5.3 文档生成参数（预留接口）
统一做成一个结构体 `DocContext`，由：
- `job_params`（用户输入）
- `aggregated_frames`（由 frame 列表统计得出：总张数、册次、目录条目等）
- `project_special_rules`（例如 1818 特殊模板）

---

## 6. 模板体系（必须版本化，可持续扩展）

### 6.1 图幅模板（15个图幅）
目标：把“图框固有特性字段”绑定到 DXF 中可定位对象。

**模板文件建议：`templates/frames/<template_id>.yaml`**
- `template_id`：例如 `A0+1_2`
- `outer_frame_signature`：
  - 外框识别策略：polyline/line/insert
  - 长宽比/尺寸签名（来自你上传的标准图框 DXF 实测）
  - 容差策略（比例/长度/角度）
- `titleblock_roi`：右下角图签区域（相对外框的归一化窗口）
- `anchors`：图签必备锚点（例如公司抬头、CNPE 等；支持去空格/去格式码）
- `fields`：字段绑定清单（**这是你后续要逐个提供并让系统固化的部分**）
  - 字段定位优先级：`ATTRIB(tag)` > `label+value_box` > `normalized_box`
  - 解析规则：正则、去空格、去 MTEXT 格式码、数值化等
  - 校验规则：例如比例 `\d+:\d+`，张数 `共X张第Y张` 等

**字段绑定示例（概念）**
```yaml
fields:
  - name: 图幅
    locator: { type: attrib, tag: PAPER }
    parser: { type: text, normalize: true }
  - name: 比例
    locator: { type: label_box, label_regex: "比例", box_offset: [dx, dy], search_radius: 50 }
    parser: { type: regex, pattern: "(\\d+)\\s*:\\s*(\\d+)" }
  - name: 张数特性
    locator: { type: text_regex_in_roi, roi: titleblock, pattern: "共\\s*(\\d+)\\s*张\\s*第\\s*(\\d+)\\s*张" }
    parser: { type: sheet_count }
```

### 6.2 文档模板（封面/目录/设计文件）
你已提供：
- 通用封面：`封面模板文件.docx`
- 通用目录：`目录模板文件.xlsx`
- 通用设计文件：`设计文件模板.xlsx`
- 1818 封面：`1818图册封面模板.docx`
- 1818 目录：`1818图册目录模板.xlsx`
- IED 模板：`IED计划模板文件.xlsx`（是否纳入交付包可配置）

**项目特殊规则**
- `project_no == "1818"`：封面/目录模板切换为 1818 版本；其他规则共通。

**模板参数映射（预留接口）**
- 建议在后端配置 `templates/docs/index.yaml`：
  - 每个模板：文件路径 + 单元格映射 + 目录表起始行 + PDF 导出策略

---

## 7. 目录结构建议（便于 Cursor 开发与后续维护）

```
repo/
  backend/
    app/
      main.py                 # FastAPI 入口
      api/                    # 路由：jobs, upload, download
      services/
        job_manager.py        # 任务生命周期
        converter_oda.py      # ODA 调用封装
        dxf_parser.py         # ezdxf 读取与通用工具（文本归一化等）
        frame_detector.py     # 图框识别（外框+图签锚点）
        template_registry.py  # 15 图幅模板加载/匹配
        titleblock_reader.py  # 图签字段提取（按模板）
        splitter.py           # 按 bbox 裁切拆分
        pdf_exporter.py       # 子图 PDF 导出
        doc_generator/
          cover.py            # 封面生成（Word + PDF）
          catalog.py          # 目录生成（Excel + PDF）
          design.py           # 设计文件生成（Excel + PDF）
        audit_replace.py      # 词库检查/替换流水线
        packager.py           # ZIP 打包与 manifest
      models/                 # Pydantic 数据模型（Job/Frame/DocContext）
      templates/
        frames/               # 15 个图幅模板 YAML
        docs/                 # 文档模板配置（index.yaml）
      data/
        dictionaries/
          词库收集.xlsx       # 词库（上传后落盘）
    workers/
      worker.py               # 后台 worker 入口
    storage/
      jobs/                   # 任务运行目录（每 job 一个子目录）
  frontend/
    ...                       # 简化前端或静态页面
  README.md
```

---

## 8. 后端 API（建议，便于前端与新 AI 直接实现）

### 8.1 创建交付包任务（流水线 A）
- `POST /api/jobs/deliverable`
  - form-data：`dwg_files[]`, 可选 `project_no`, 可选 `options.json`, 可选 Excel 参数文件
  - 返回：`job_id`

### 8.2 创建检查/替换任务（流水线 B）
- `POST /api/jobs/audit-replace`
  - form-data：`dwg_files[]`, `project_no`, `lexicon.xlsx`（词库收集）
  - 可选：`mode=check|replace`
  - 返回：`job_id`

### 8.3 查询任务状态
- `GET /api/jobs/{job_id}`
  - 返回：状态、进度、阶段、错误信息、可下载产物列表

### 8.4 下载产物
- `GET /api/jobs/{job_id}/download`
  - 交付包：ZIP
- `GET /api/jobs/{job_id}/artifacts/{name}`
  - 下载单个报表/单个 PDF（可选）

---

## 9. 任务执行的阶段划分（用于进度条与日志）

建议阶段（deliverable）：
1. `INGEST`：落盘与校验
2. `CONVERT_DWG_TO_DXF`
3. `DETECT_FRAMES`
4. `READ_TITLEBLOCK_FIELDS`
5. `SPLIT_EXPORT_SUBDRAWINGS`
6. `EXPORT_PDF`
7. `GENERATE_DOCS`（封面/目录/设计文件 + PDF）
8. `PACKAGE_ZIP`
9. `DONE`

日志要求：
- 每个阶段写入 `logs/job.log`
- 每张图/每个 frame 写入 `reports/frame_results.jsonl`
- 失败隔离：单图失败不影响全局（可配置）

---

## 10. 文档生成模块：必须预留的接口（你后续会补参数）

### 10.1 输入接口（DocContext）
- `project_no`
- `doc_set_id`（例如图册编号/册次）
- `frames[]`：每张子图的 meta（图号、图名、图幅、比例、专业、页数、状态、版次…）
- `user_params`：用户在 Web 端输入的通用字段（工程号、系统号、阶段等）
- `rules`：生成规则（目录行排序、编号规则、1818 特殊字段等）

### 10.2 输出接口
- `generate_cover(context) -> cover.docx + cover.pdf`
- `generate_catalog(context) -> catalog.xlsx + catalog.pdf`
- `generate_design_files(context) -> design.xlsx + design.pdf`
- （可选）`generate_ied(context) -> ied.xlsx + ied.pdf`

> 注意：你提供的封面模板是“Word 内嵌 Excel(OLE)”形式，导出 PDF 时建议优先用 Office COM 以保证 OLE 刷新。

---

## 11. 图幅模板库：必须预留的接口（你后续会逐个上传 15 个图框）

### 11.1 模板注册与匹配
- `load_frame_templates(dir) -> templates[]`
- `match_template(frame_bbox, anchors, candidates) -> template_id + scale_factor + confidence`

### 11.2 字段提取（按模板）
- `extract_fields(dxf_doc, frame_bbox, template) -> titleblock_meta`
- 支持三种定位方式：
  - `ATTRIB(tag)`
  - `label+value_box`（标签文字 + 右侧小框取值）
  - `normalized_box`（纯位置模板）

### 11.3 识别稳定性策略（建议）
- “图签锚点（公司抬头/CNPE）”作为强锚点，先定位图签再反推外框（降低复杂图纸干扰）
- 外框支持：LWPOLYLINE 矩形、LINE 拼矩形、INSERT 块外框（按模板配置优先级）

---

## 12. 与“词库收集.xlsx”对接（流水线 B）

- 词库表结构：第 1 行为项目号列头；从第 3 行起为关键词列表
- 解析接口：
  - `load_lexicon(xlsx_path) -> {project_no: [keywords...]}` 或按需加载单列
- 检查输出：
  - `audit_report.xlsx/csv/jsonl`：包含 `dwg_name / frame_id / entity_type / layer / text_raw / text_norm / hit_keyword / x,y`
- 替换模式：
  - 高风险短串限制：默认仅在图签 ROI 内替换
  - 全局替换需开关 + dry-run 报告

---

## 13. 你接下来与新 AI 的协作方式（开发步骤建议）

1. 先实现后端骨架（FastAPI + Job + Worker + 文件落盘 + 状态查询）
2. 接通 ODA 转换（DWG→DXF）
3. 接通最小图框识别（先用“图签锚点 + 外框矩形”）
4. 接通最小拆分（按 bbox 复制实体 → 子 DXF）
5. 接通 PDF 输出（子 DXF → PDF）
6. 接通 ZIP 打包（产物目录结构固定）
7. 再逐步引入：
   - 15 图幅模板库（你将逐个提供）
   - 文档生成模块参数（你将逐步提供）
   - 词库检查/替换模块（以 `词库收集.xlsx` 为输入）

---

## 14. 文件与模板清单（当前已知）
- 图幅模板：待你后续上传 15 个图框 DXF 并定义字段
- 文档模板（已提供）：
  - 通用封面：封面模板文件.docx
  - 通用目录：目录模板文件.xlsx
  - 通用设计文件：设计文件模板.xlsx
  - 1818 封面：1818图册封面模板.docx
  - 1818 目录：1818图册目录模板.xlsx
  - IED：IED计划模板文件.xlsx
- 词库：词库收集.xlsx

---

## 15. 备注：关于“文件过期”
本对话环境中，较早上传的一部分文件可能会出现“已过期不可读”的情况。若后续需要我继续解析某个历史文件，请你重新上传一次以确保可读取。
