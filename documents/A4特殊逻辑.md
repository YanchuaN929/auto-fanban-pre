# A4 多页说明图（001）成组处理规则（补充规则）

> 目的：解决高频场景（约 80%）：同一 DWG/DXF 内存在多张 A4 说明页（001），其中**只有第 1 张有图签/标题栏信息**，其余页通常只有外框 + 右上角页码/说明。  
> 要求：识别为同一“001 图纸集合（sheet-set）”，按页码排序切出所有 A4 页，保持页与页之间几何关系不变，统一输出 PDF 与 DWG（或 DXF→DWG）。

---

## 0. 前提与原则

1. 生产后端没有“标定图层/红框定位矩形”，只能依赖：
   - 外框几何识别（闭合矩形或 LINE 重建）
   - rb_offset ROI（按 1:1 标定，运行时按外框缩放适配）
2. 所有一致性问题（比例不一致、页数对不上、缺页等）必须：
   - **抛出 flags/提醒**
   - **不中断运行**（继续裁切、继续输出）

---

## 1. 触发条件（何时启用 A4 多页规则）

当同一 DXF 中出现满足以下条件的 A4 图框簇（cluster），启用本规则：

1) 检测到 ≥2 个 A4 外框（允许任意缩放/横竖向，靠外框几何拟合判定 A4）  
2) 这些 A4 外框属于同一空间簇（见第 3 节）  
3) 簇内存在至少 1 个“有图签的第一页（Master Page）”，判定条件：
   - 锚点 ROI 命中：`CNPE` 或 `中国核电工程有限公司`（或你固化的锚点集合）
   - 且标题栏字段 ROI 能提取关键字段（至少包含：工程号/内外部编码/张数字段中的数字）

---

## 2. 名词定义

- 外框（outer frame）：每个图框的最大矩形边界 bbox=(xmin,ymin,xmax,ymax)
- A4 外框：外框拟合到 A4 尺寸（1:1 为 210×297 或 297×210），允许整体缩放
- Master Page：簇内唯一（或最优）带图签锚点、能读取标题栏信息的页面（通常第 1 张）
- Slave Page：簇内其它 A4 页，通常无图签，仅有右上角页码/说明
- Sheet-Set：同一簇内所有 A4 页，整体作为“001 图纸”的输出单元

---

## 3. 外框识别、A4 判定与簇构建

### 3.1 外框识别（必须支持两种）
- 优先：闭合 `LWPOLYLINE` / `POLYLINE(closed)` 矩形
- 兜底：`LINE` 重建矩形（端点聚类→共线→闭合→取包络矩形）

### 3.2 A4 判定（允许任意缩放）
对外框：
- W_obs = xmax-xmin
- H_obs = ymax-ymin

对两种朝向分别拟合：
- 竖向 A4：W_canon=210, H_canon=297
- 横向 A4：W_canon=297, H_canon=210

计算：
- sx = W_obs / W_canon
- sy = H_obs / H_canon
- geom_scale = (sx+sy)/2
- fit_error = max(|sx-geom_scale|, |sy-geom_scale|)/max(geom_scale, 1e-9)

若 fit_error <= uniform_scale_tol（建议 2%），判定为 A4，并记录：
- paper=A4, orientation=portrait/landscape
- sx, sy, geom_scale

### 3.3 A4 簇构建（防止混入其它 A4）
把同一 DXF 中所有 A4 外框作为节点，连边规则（建议）：
- 若两个外框最小水平间距 min_dx < gap_threshold 且最小竖向间距 min_dy < gap_threshold，则连边
- gap_threshold 建议：0.5 * min(W_obs, H_obs)（随比例缩放自适应）
取连通分量作为 cluster。

---

## 4. Master Page（第一页/有图签页）定位

在 cluster 内，对每个 A4 外框做复核：

1) 先做锚点 ROI 检测（CNPE/中国核电工程有限公司）  
2) 锚点命中后，用 A4 对应 roi_profile（通常 RB_PROFILE_SMALL5）提取标题栏字段  
3) 若关键字段命中数 ≥3（工程号/内部编码/外部编码/张数字段等），则判为 Master 候选

若出现多个 Master 候选：
- 选“字段命中数量最多”的
- 若仍并列，选“能解析出 page_total 且 page_index=1”的

---

## 5. ROI（rb_offset）运行时缩放还原（适配任意比例）

所有字段 ROI 均存为 1:1 的 rb_offset：
- dx_right = outer_xmax - roi_xmax
- dx_left  = outer_xmax - roi_xmin
- dy_bottom = roi_ymin - outer_ymin
- dy_top    = roi_ymax - outer_ymin

运行时按外框拟合得到 sx/sy，还原 ROI 绝对坐标：
- xmin_roi = outer_xmax - dx_left  * sx
- xmax_roi = outer_xmax - dx_right * sx
- ymin_roi = outer_ymin + dy_bottom * sy
- ymax_roi = outer_ymin + dy_top    * sy

> 注意：A4 标题栏字段提取使用 RB_PROFILE_SMALL5（与 A3 共用），但纸张类型必须由外框几何拟合决定。

---

## 6. 解析张数信息（Master 必须读到）

张数信息在不同模板可能两种形态：必须同时支持。

### 6.1 整句文本形态
在 Master 的“张数 ROI”内匹配：
- 共\s*(\d+)\s*张.*第\s*(\d+)\s*张
得到：
- page_total = X
- page_index_master = Y（通常 Y=1）

### 6.2 框内数字形态（句子被拆成框+数字）
若 ROI 内无整句，但能读到 2 个数字（例如 {1,7}）：
- page_total = max(nums)
- page_index_master = min(nums)（通常为 1）

异常处理（不中断）：
- 若 page_index_master != 1 → flags += ["A4多页_首页页码异常"]
- 若 page_total < 2 → 不按多页处理，回落到普通 A4 单页逻辑

---

## 7. Slave 页页码识别（右上角）

Slave 页通常无图签锚点，因此页码识别必须独立于标题栏 ROI。

建议采用“两层策略”：固定 ROI 优先，失败则位置评分兜底。

### 7.1 固定 ROI（推荐）
新增一个“右上角页码标记 ROI”（A4 1:1 初始值，后续可用样本校准）：
- A4_page_marker_rb_offset_1to1 = [dx_right=20, dx_left=120, dy_bottom=255, dy_top=295]

运行时按 sx/sy 还原为绝对 ROI 后，在 ROI 内匹配：
- 共\s*(\d+)\s*张\s*第\s*(\d+)\s*张
得到：
- page_total_i（可用于交叉校验）
- page_index_i

### 7.2 位置评分兜底（防模板漂移）
若固定 ROI 未命中：
1) 在该外框内部搜候选文本：
   - 优先：包含“第”“张”的文本
   - 兜底：纯数字文本
2) 计算归一化位置：
   - xnorm=(x-xmin)/W_obs
   - ynorm=(y-ymin)/H_obs
   仅保留：xnorm>=0.60 且 ynorm>=0.85
3) 评分：
   - score=2*xnorm + 2*ynorm + bonus
   - bonus=1（命中“第N张”正则）否则 0
取最高分作为页码来源并解析。

识别失败（不中断）：
- flags += ["A4多页_页码缺失"]

---

## 8. 张数一致性校验（必须做但不中断）

以 Master 的 page_total 为准：
- 若 cluster 内 A4 外框数 != page_total → flags += ["A4多页_页数不一致"]
- 若页码重复 → flags += ["A4多页_页码重复"]
- 若缺页/不连续 → flags += ["A4多页_页码不连续"]
- 若存在 page_total_i 与 Master 不一致 → flags += ["A4多页_页总数冲突"]

无论 flags 如何，继续裁切与输出。

---

## 9. 元数据继承与回填（让 001 信息完整）

默认：整组 001（sheet-set）的元数据取自 Master（标题栏提取结果）：
- 工程号/子项号/内部编码/外部编码/专业/标题/版次/状态/日期/比例文本等

回填（建议）：
- 若 Master 缺失某关键字段（常见：内部编码/标题），从 Slave 页做“多数表决回填”
- 回填成功：flags += ["A4多页_元数据回填"]

（可选）为回填提供一个右上角文本 ROI（A4 1:1 初始值）：
- A4_internal_code_rb_offset_1to1 = [dx_right=30, dx_left=160, dy_bottom=270, dy_top=295]

---

## 10. 裁切输出（保持多页 A4 间几何关系不变）

要求：输出 DWG（或 DXF→DWG）时，各 A4 外框之间的相对距离/排布不变。

做法：
1) 对 cluster 内每个外框定义裁切 bbox：
   - clip_bbox = outer_bbox + margin
   - margin 建议 1%~2%（随 W_obs/H_obs 自适应）
2) 实体保留策略（稳妥低成本版）：
   - 实体 bbox 与任一 clip_bbox 相交则保留（避免严格裁剪导致漏图）
3) **不做平移/不归零坐标**：保持原始坐标，确保外框相对关系不变。
4) 输出集合图：保留外框本体。

---

## 11. PDF 输出（优先多页，允许兜底）

优先：多页 PDF（每个 A4 外框一页）：
- 按 page_index 排序（1..page_total）
- 逐页窗口打印（plot window = outer_bbox）生成 PDF 页，再合并为一个多页 PDF

兜底：若无法合并多页：
- 以 cluster 的 union bbox 打印 extents，生成单页大图 PDF
- flags += ["A4多页_PDF兜底为单页大图"]

---

## 12. 中间结果结构（建议后端统一输出）

```json
{
  "sheet_set_type": "A4_MULTI_PAGE_001",
  "paper": "A4",
  "cluster_id": "uuid",
  "page_total": 7,
  "master_page": {
    "outer_bbox": [xmin, ymin, xmax, ymax],
    "extracted_14_fields": { "...": "..." }
  },
  "pages": [
    { "page_index": 1, "outer_bbox": [...], "has_titleblock": true  },
    { "page_index": 2, "outer_bbox": [...], "has_titleblock": false },
    ...
  ],
  "flags": ["比例不一致", "A4多页_页码不连续"]
}
