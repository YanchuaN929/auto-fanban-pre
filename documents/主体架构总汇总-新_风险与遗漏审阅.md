# `主体架构总汇总 - 新.md` 审阅报告（潜在风险与逻辑遗漏）

> 目标：对 `documents/主体架构总汇总 - 新.md` 做一致性与可落地性审阅，结合当前仓库内的：
> - `documents/参数规范.yaml`（权威配置）
> - `documents/参数表.md`（人读说明）
> - `documents/A4特殊逻辑.md`（A4多页解释）
> - `documents/工具列表.yaml`（脚本能力）
>
> 输出：列出潜在风险、逻辑遗漏与歧义点，并给出可执行修正建议。

---

## 1) 潜在风险（可能导致开发卡点或运行时问题）

| ID | 问题 | 影响 | 建议 |
|---:|------|------|------|
| R1 | 【已解决】词库文件已存在：`documents_bin/词库收集.xlsx` | 无 | 无需处理 |
| R2 | 【已解决】`subitem_name` 已改为前端输入，取消子项号映射 | 无 | 无需处理 |
| R3 | **专业代码映射不完整**：目前仅定义结构/建筑/总图运输 | 非已定义专业的图纸会在“专业代码”派生失败 | 补全映射；或提供兜底：未知专业写空并打 flag，且允许前端手工补录 |
| R4 | **status→design_phase 映射不完整**：仅 `CFC→施工图设计`，未覆盖 AFC/ACFC 等 | 非 CFC 状态下 `design_phase` 为空，影响设计文件输出 | 补全 `status_to_design_phase`，或定义默认映射策略（例如：原样透传/统一映射为“施工图设计”仅在CFC） |
| R5 | 【已解决】ODA 路径已在 `参数规范_运行期.yaml` 中定义 | 无 | 无需处理 |
| R6 | 【已解决】DWG 输出已明确为**必须**，文档口径已统一 | 无 | 无需处理 |
| R7 | 【已解决】并发/超时等运行参数已在 `参数规范_运行期.yaml` 中定义 | 无 | 无需处理 |

---

## 2) 逻辑遗漏（文档未覆盖但实现必须面对的场景）

| ID | 问题 | 影响 | 建议 |
|---:|------|------|------|
| L1 | **错误处理与重试机制未定义**：只写“不中断/打flag”，未定义重试次数/超时/失败分级 | 外部程序（ODA/Office/LibreOffice）失败时行为不一致 | 增加 `failure_policy`：`max_retries`、`retry_backoff_ms`、`timeout_ms`、`fail_fast_steps`（如INGEST）等 |
| L2 | **上传限制未定义**：最大文件大小/文件数量/磁盘空间预检查 | 可能 OOM/磁盘写满/任务无法完成 | 增加 `upload_limits`：`max_files`、`max_total_mb`、`allowed_extensions`、`min_free_disk_mb` |
| L3 | **任务生命周期管理缺失**：产物保留多久、清理策略、取消任务如何处理 | 磁盘持续增长；取消可能留下半成品 | 增加 `job_lifecycle`：`retention_hours`、`cleanup_on_cancel`、`cleanup_cron` |
| L4 | **前端校验规则如何同步**：YAML存在大量 `required_when`，架构文档未说明“如何驱动前端校验” | 前端体验差，错误晚发现 | 明确“前端表单/校验由YAML生成”的策略：后端提供 `GET /spec` 或生成 `frontend_validation_rules.json` |
| L5 | **Office COM 失败降级**：仅写“office_com优先”，未定义 Office 未安装/COM失败后的策略 | 无 Office 环境直接不可用 | 明确策略：允许 `libreoffice` 作为后备；或明确“部署机器必须安装 Office”，并把失败原因写入日志/manifest |
| L6 | **多DWG文件合并语义不明确**：支持多DWG上传，但未定义是否同图册/冲突处理/排序策略 | 多文件时结果不确定、容易踩坑 | 明确默认：同一 job 视作同图册；输入排序规则（按文件名/上传顺序）；`internal_code` 冲突策略（报错/保留首个/按revision） |
| L7 | **manifest.json 结构未规范化**：文档强调重要，但未给 schema/示例字段 | 实现分叉，难以对接前端/审计 | 在架构文档补充 `manifest` 示例与字段说明（inputs/options/derived/flags/errors/artifacts/versions） |
| L8 | **词库替换的原子性/回滚未定义**：replace模式未描述失败回滚、输出对比物 | 可能产生半替换文件，难追溯 | 增加：先输出到临时目录；全部成功后再发布；提供 before/after 对比清单与可选PDF对比 |

---

## 3) 一致性 / 歧义点（会导致理解偏差或实现口径不一致）

| ID | 问题 | 建议修正 |
|---:|------|----------|
| C1 | 【已解决】1818封面落点差异已在架构文档强调 | 无 | 无需处理 |
| C2 | **横向A4支持点未闭环，但我确认全部为竖向，无须考虑横向**|
| C3 | 【已解决】目录页数算法已补充“分页信息优先 + 双导出兜底” | 无 | 无需处理 |
| C4 | 【已确认】模板/图框已齐全，暂不做版本管理要求 | 无 | 无需处理 |

---

## 4) 建议新增的章节（让架构更可落地）

1. **异常场景处理矩阵**：列出 ODA/COM/ROI提取/A4页码失败等异常，分别给出：是否重试、是否降级、是否中断、flag 名称与用户提示文案。
2. **配置热更新策略**：`参数规范.yaml` 是否允许热加载；若允许，如何保证任务运行中版本一致（spec_version 固化到 job）。
3. **安全与内网合规**：上传白名单、目录穿越防护、日志脱敏、任务目录权限、病毒扫描（如需要）。
4. **任务调度与资源治理**：并发上限、队列长度、单任务CPU/内存/磁盘预算与保护策略。

---

## 5) 建议的下一步动作（可选）

- 把 R/L/C 项转成一个可追踪的清单（例如 `documents/遗漏检查.yaml` 的“架构审阅”分组），逐条确认后再回写到 `主体架构总汇总 - 新.md`。

