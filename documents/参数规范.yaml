# ============================================================================
# CNPE 图纸处理系统 - 参数规范 v2.0
# ============================================================================
# 本文件包含两个独立模块的参数规范：
#   1. doc_generation    - 文档生成模块（封面/目录/设计文件/IED计划）
#   2. titleblock_extract - 图签提取模块（DXF 解析/ROI 识别/字段解析）
# 运行期参数（并发/超时/路径/清理策略）见：documents/参数规范_运行期.yaml
# ============================================================================

schema_version: "2.0"
last_updated: "2025-01-13"

# ============================================================================
# 一、通用枚举定义
# ============================================================================
enums:
  # 项目号（用于模板切换和词库匹配）
  project_no:
    - { id: "1818", name: "巴基斯坦恰希玛核电厂五号机组" }
    - { id: "2016", name: "浙江金七门核电厂1、2号机组" }
    - { id: "2026", name: "江苏徐圩核能供热发电厂一期工程" }
    - { id: "1916", name: "福建漳州核电厂3、4号机组" }
    - { id: "1907", name: "三门核电项目5、6号机组" }
    - { id: "2035", name: "600MV高温气冷堆示范工程" }
    - { id: "1418", name: "海南昌江核电厂3、4号机组" }

  # 封面模板变体（非1818使用）
  cover_variant: ["通用", "压力容器", "核安全设备"]

  # PDF 引擎
  pdf_engine: ["office_com", "libreoffice"]

  # IED 变更标记
  ied_change_flag: ["MOD", "CAN", "REC", "IDM"]

  # IED 文档类型
  ied_doc_type: ["图册", "文件", "图纸", "章节"]

  # 专业代码映射
  discipline_code_map:
    结构: "JG"
    建筑: "JZ"
    总图运输: "ZY"
    # 其他专业待补充
  
  # 专业中英文映射（用于1818封面）
  discipline_en_map:
    结构: "Structural"
    建筑: "Architectural"
    总图运输: "Site & Transportation"
    # 其他专业待补充
  
  # 设计阶段中英文映射（用于1818封面）
  design_phase_en_map:
    施工图设计: "Constructing Design"
    # 其他阶段待补充

# ============================================================================
# 二、文档生成模块 (doc_generation)
# ============================================================================
doc_generation:
  description: |
    文档生成模块负责基于图签提取结果生成：封面(Word+PDF)、目录(Excel+PDF)、
    设计文件(Excel+PDF)、IED计划(仅Excel，单独输出，不导出PDF且不打包入package.zip)。DXF 仅作为中间文件，不对用户输出。

  # --------------------------------------------------------------------------
  # 2.1 生成选项
  # --------------------------------------------------------------------------
  options:
    enabled:        { type: bool, default: true,  desc: "文档生成总开关（true时全部生成）" }
    export_pdf:     { type: bool, default: true,  desc: "是否导出PDF（必须）" }
    pdf_engine:     { type: enum, default: "office_com", desc: "PDF引擎（含OLE时推荐office_com）" }
    pdf_margin_mm:  { type: object, default: { top: 20, bottom: 10, left: 20, right: 10 }, desc: "DXF→PDF 打印页边距（单位mm，指PDF页面边缘到图框最大外框线的距离）" }

  # --------------------------------------------------------------------------
  # 2.2 全局参数定义
  # --------------------------------------------------------------------------
  # 字段属性说明：
  #   type     - 数据类型
  #   required - 是否必填（或 required_when 条件必填）
  #   source   - 数据来源：frontend(前端输入) / dxf(图签提取) / derived(派生计算)
  #   default  - 默认值
  #   target   - 写入目标模板位置
  #   desc     - 字段说明
  # --------------------------------------------------------------------------
  params:
    # ========== 项目级参数 ==========
    project:
      project_no:
        type: str
        required: true
        source: frontend
        desc: "项目号，用于模板切换和规则分支"
      
      cover_variant:
        type: enum[cover_variant]
        required_when: "project_no != '1818'"
        source: frontend
        default: "通用"
        desc: "非1818封面模板选择"
      
      classification:
        type: str
        required: true
        source: frontend
        default: "非密"
        desc: "密级，写入封面/设计文件/IED"
      
      approved_by:
        type: str
        required: false
        source: frontend
        deprecated: true
        desc: "封面批准人：已确认取消，不读取也不编辑（保留字段仅为兼容旧表单）"

    # ========== 图签提取的全局聚合值（来自001图纸） ==========
    from_titleblock:
      engineering_no:    { type: str, required: true, source: "dxf:frames[001].titleblock.engineering_no", desc: "工程号(4位)" }
      subitem_no:        { type: str, required: true, source: "dxf:frames[001].titleblock.subitem_no",     desc: "子项号" }
      subitem_name:
        type: str
        required: true
        source: frontend
        desc: "子项名称（中文）（前端直接输入）"
      subitem_name_en:
        type: str
        required_when: "project_no == '1818'"
        source: frontend
        desc: "子项名称（英文）（仅1818项目，前端直接输入）"
      discipline:        { type: str, required: true, source: "dxf:frames[001].titleblock.discipline",     desc: "专业（取001图纸）" }
      revision:          { type: str, required: true, source: "dxf:frames[001].titleblock.revision",       desc: "版次" }
      doc_status:        { type: str, required: true, source: "dxf:frames[001].titleblock.status",         desc: "状态" }

    # ========== 封面参数 ==========
    cover:
      album_title_cn:
        type: str
        required: true
        source: frontend
        desc: "图册名称(中文)，写入封面I21/I22"
      
      album_title_en:
        type: str
        required_when: "project_no == '1818'"
        source: frontend
        desc: "图册名称(英文)，仅1818需要，写入I23/I24"
      
      cover_revision:
        type: str
        required: false
        source: frontend
        default: "A"
        desc: "封面版次，写入封面版次位（追加模式）"

    # ========== 目录参数 ==========
    catalog:
      upgrade_start_seq:  { type: int, required: false, source: frontend, desc: "升版起始尾号(如5表示005)" }
      upgrade_end_seq:    { type: int, required: false, source: frontend, desc: "升版结束尾号(如12表示012)" }
      upgrade_revision:   { type: str, required: false, source: frontend, desc: "升版版本(如B/C)" }
      upgrade_note_text:  { type: str, required: false, source: frontend, default: "升版", desc: "升版标记文本" }

    # ========== 设计文件参数 ==========
    design:
      wbs_code:
        type: str
        required: true
        source: frontend
        desc: "WBS编码，全图册共用"
      
      system_code:       { type: str, required: false, source: frontend, default: "NA", desc: "系统代码" }
      system_name:       { type: str, required: false, source: frontend, default: "NA", desc: "系统名称" }
      design_status:     { type: str, required: false, source: frontend, default: "编制", desc: "设计文件状态(A列)" }
      internal_tag:      { type: str, required: false, source: frontend, default: "否",  desc: "内部标识(I列)" }
      discipline_office: { type: str, required: false, source: frontend, desc: "专业室(P列)" }
      file_category:     { type: str, required: true,  source: frontend, desc: "文件类别(U列)，选项来自模板Sheet5" }
      attachment_name:   { type: str, required: false, source: frontend, desc: "附件名称(W列)" }
      qa_required:       { type: str, required: false, source: frontend, default: "否", desc: "是否质保核查(X列)" }
      qa_engineer:       { type: str, required: false, source: frontend, desc: "质保核查工程师(Y列)" }
      work_hours:        { type: str, required_when: "ied_status == '发布'", source: frontend, default: "100", desc: "工时数，同时写入设计文件Z列和IED AT列" }

    # ========== IED计划参数 ==========
    ied:
      # --- 基本信息 ---
      ied_status:        { type: str, required: true,  source: frontend, default: "发布", desc: "IED状态(D列)，发布时触发更多必填校验" }
      ied_doc_type:      { type: str, required: true,  source: frontend, desc: "文档类型(C列)" }
      ied_change_flag:   { type: str, required: false, source: frontend, desc: "变更标记(B列)" }
      
      # --- 设计类型与责任 ---
      ied_design_type:      { type: str, required: false, source: frontend, desc: "设计类型(V列)，选项来自模板Sheet4" }
      ied_responsible_unit: { type: str, required: false, source: frontend, desc: "责任单位(X列)，选项来自responsible_unit.json" }
      ied_discipline_office:
        type: str
        required_when: "ied_status == '发布'"
        source: frontend
        transform: "取最后一个'-'后的文本"
        desc: "专业室(BJ列)，选项来自responsible_unit.json"
      ied_chief_designer: { type: str, required: false, source: frontend, format: "姓名@ID", desc: "责任设总(W列)" }
      
      # --- 人员资格 ---
      ied_person_qual_category:
        type: str
        required_when: "ied_status == '发布'"
        source: frontend
        default: "一般核安全物项-民用"
        desc: "人员资格类别(M列)"
      
      # --- 标记与标识 ---
      ied_fu_flag:       { type: str, required: false, source: frontend, default: "N",  desc: "FU标记(R列)" }
      ied_internal_tag:  { type: str, required: false, source: frontend, default: "否", desc: "内部标识(U列)" }
      
      # --- 编审链（发布状态必填，格式: 姓名@ID / YYYY-MM-DD） ---
      ied_prepared_by:           { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "姓名@ID",    desc: "编制者(AY列)" }
      ied_prepared_by_2:         { type: str,  required: false,                       source: frontend, format: "姓名@ID",    desc: "第二编制者(AZ列)" }
      ied_prepared_date:         { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "YYYY-MM-DD", desc: "编制日期(BA列)" }
      ied_checked_by:            { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "姓名@ID",    desc: "校核者(BB列)" }
      ied_checked_date:          { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "YYYY-MM-DD", desc: "校核日期(BC列)" }
      ied_discipline_leader:     { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "姓名@ID",    desc: "工种负责人(BD列)" }
      ied_discipline_leader_date: { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "YYYY-MM-DD", desc: "工种负责人审核日期(BE列)" }
      ied_reviewed_by:           { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "姓名@ID",    desc: "审核者(BF列)" }
      ied_reviewed_date:         { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "YYYY-MM-DD", desc: "审核日期(BG列)" }
      ied_approved_by:           { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "姓名@ID",    desc: "审定者(BH列)" }
      ied_approved_date:         { type: str,  required_when: "ied_status == '发布'", source: frontend, format: "YYYY-MM-DD", desc: "审定日期(BI列)" }
      
      # --- 计划日期（格式: YYYY-MM-DD，文本格式） ---
      ied_submitted_plan_date: { type: str, required: false, source: frontend, format: "YYYY-MM-DD", desc: "所提交计划(N列)" }
      ied_publish_plan_date:   { type: str, required: false, source: frontend, format: "YYYY-MM-DD", desc: "出版计划(P列)" }
      ied_external_plan_date:  { type: str, required: false, source: frontend, format: "YYYY-MM-DD", desc: "外部计划(Q列)" }
      ied_fu_plan_date:        { type: str, required: false, source: frontend, format: "YYYY-MM-DD", desc: "FU计划(S列)" }

  # --------------------------------------------------------------------------
  # 2.3 派生字段规则
  # --------------------------------------------------------------------------
  derivations:
    # === 编码派生 ===
    internal_code_001:
      from: "frames[internal_code endswith '-001'].titleblock.internal_code"
      desc: "001图纸的内部编码"
    
    album_internal_code:
      from: internal_code_001
      transform: "strip_suffix('-001')"
      desc: "图册编号前缀(XXXXXXX-XXXXX)"
    
    album_code:
      from: internal_code_001
      transform: "extract_mid5_last2"
      desc: "图册编号末2位数字"
    
    cover_internal_code:
      from: internal_code_001
      transform: "replace_suffix('-001', '-FM')"
      desc: "封面内部编码"
      usage: "仅用于目录明细、设计文件、IED计划中的封面行；无需写入封面docx文件本身"
    
    catalog_internal_code:
      from: internal_code_001
      transform: "replace_suffix('-001', '-TM')"
      desc: "目录内部编码"
    
    external_code_001:
      from: "frames[internal_code endswith '-001'].titleblock.external_code"
      desc: "001图纸的外部编码(19位)"
    
    cover_external_code:
      from: external_code_001
      transform: "replace_pos(9,11,'F01')"
      desc: "封面外部编码(第9-11位替换为F01)"
      example: "JD1NHT11001B25C42SD → JD1NHT11F01B25C42SD"
    
    catalog_external_code:
      from: external_code_001
      transform: "replace_pos(9,11,'T01')"
      desc: "目录外部编码(第9-11位替换为T01)"
    
    # === 标题派生 ===
    cover_title_cn:   { from: album_title_cn, transform: "append('封面')" }
    catalog_title_cn: { from: album_title_cn, transform: "append('目录')" }
    cover_title_en:   { from: album_title_en, transform: "append(' Cover')", when: "project_no == '1818'" }
    catalog_title_en: { from: album_title_en, transform: "append(' Contents')", when: "project_no == '1818'" }
    
    # === 阶段派生 ===
    design_phase:
      from: "titleblock.status"
      transform: "map({'CFC': '施工图设计'})"
      desc: "设计阶段(CFC映射为施工图设计)"
    
    # === 版次派生 ===
    catalog_revision:
      from: "[upgrade_revision, cover_revision]"
      transform: "coalesce_nonempty"
      desc: "目录版次，优先取升版版本"
    
    # === 固定值 ===
    cover_paper_size_text:   { value: "A4文件" }
    cover_page_total:        { value: 1 }
    catalog_paper_size_text: { value: "A4文件" }
    catalog_page_total:      { from: "catalog_pdf", transform: "count_pdf_pages", note: "优先使用Excel分页信息计页；不稳定时回退为导出PDF计页" }

  # --------------------------------------------------------------------------
  # 2.4 规则与默认值
  # --------------------------------------------------------------------------
  rules:
    # 默认值集合（当用户未输入且无法从图签提取时使用）
    defaults:
      revision: "A"
      doc_status: "CFC"
      classification: "非密"
      page_count: 1
      design_status: "编制"
      ied_status: "发布"
      work_hours: "100"
      ied_fu_flag: "N"
      ied_internal_tag: "否"
      ied_person_qual_category: "一般核安全物项-民用"
      system_code: "NA"
      system_name: "NA"
      upgrade_note_text: "升版"
    
    # 目录排序规则
    catalog_sort:
      method: "by_internal_code"
      desc: "按internal_code尾号XXX升序排序后写入"
      alternatives: ["by_drawing_no", "by_file_code", "custom"]
    
    # 映射表集合
    mappings:
      discipline_to_code:
        结构: "JG"
        建筑: "JZ"
        总图运输: "ZY"
      discipline_to_en:
        结构: "Structural"
        建筑: "Architectural"
        总图运输: "Site & Transportation"
      status_to_design_phase:
        CFC: "施工图设计"
      design_phase_to_en:
        施工图设计: "Constructing Design"

  # --------------------------------------------------------------------------
  # 2.5 字段优先级与覆盖约定
  # --------------------------------------------------------------------------
  field_priority:
    desc: "对同名字段(如discipline/design_phase/revision/status)按以下优先级取值"
    order:
      - { level: 1, source: "FrameMeta", desc: "每张图图签/模板提取值，且通过校验" }
      - { level: 2, source: "GlobalDocParams", desc: "用户输入全局值" }
      - { level: 3, source: "rules.defaults", desc: "系统默认值" }
    manifest_output:
      recommended: true
      content:
        - "field -> source(frame/global/default) -> value"
        - "缺失/不合法字段清单（用于前端提示）"

  # --------------------------------------------------------------------------
  # 2.5 模板配置
  # --------------------------------------------------------------------------
  templates:
    # 模板选择规则
    selection:
      cover:
        "1818": "documents_bin/1818图册封面模板.docx"
        default: "documents_bin/封面模板文件{variant}.docx"  # variant: 空/压力容器版/核安全设备版
      catalog:
        "1818": "documents_bin/1818图册目录模板.xlsx"
        default: "documents_bin/目录模板文件.xlsx"
      design: "documents_bin/设计文件模板.xlsx"
      ied: "documents_bin/IED计划模板文件.xlsx"

    # --- 封面落点 ---
    cover_bindings:
      # 通用封面（封面模板文件*.docx，内嵌Sheet"封面"）
      common:
        engineering_no:      { cell: "I11", label: "D11" }
        subitem_no:          { cell: "I13", label: "D13" }
        subitem_name:        { cell: "I15", label: "D15" }
        design_phase:        { cell: "I17", label: "D17" }
        discipline:          { cell: "I19", label: "D19" }
        album_title_cn:      { cell: "I21+I22", split_rule: "cn_split_prefer_right_is_cjk_near_half" }
        album_code:          { cell: "I25:S25", merge: true }
        album_internal_code: { cell: "N3:S3", merge: true }
        cover_revision:      { cell: "N5:P5", merge: true, write_mode: "append_after_label", label: "版次：" }
        doc_status:          { cell: "Q5:S5", merge: true, write_mode: "append_after_label", label: "状态：", source: "doc_status", note: "来源为001图纸的status值" }
        cover_external_code: { cell: "B29:T29", note: "19位逐格写入" }
        册次:                { cell: "N4", fixed: true, note: "模板固定值，不做变量处理" }
        # 注：密级(classification)无需程序写入封面
      
      # 1818封面（1818图册封面模板.docx，内嵌Sheet"封面"）
      # 注意：1818封面单元格位置与通用封面不同！
      "1818":
        engineering_no:      { cell: "I10", label: "D10/D11" }      # 比通用少1行
        subitem_no:          { cell: "I12", label: "D12/D13" }      # 比通用少1行
        subitem_name:        { cell: "I14", label: "D14", desc: "子项名称（中文）" }
        subitem_name_en:     { cell: "I15", label: "D15", desc: "子项名称（英文）" }
        design_phase:        { cell: "I16", label: "D16", desc: "设计阶段（中文）" }
        design_phase_en:     { cell: "I17", label: "D17", desc: "设计阶段（英文），由映射表生成" }
        discipline:          { cell: "I18", label: "D18", desc: "专业（中文）" }
        discipline_en:       { cell: "I19", label: "D19", desc: "专业（英文），由映射表生成" }
        album_title_cn:      { cell: "I21+I22", split_rule: "cn_split_prefer_right_is_cjk_near_half" }
        album_title_en:      { cell: "I23+I24", split_rule: "en_split_on_whitespace_between_words_near_half" }
        album_code:          { cell: "I25", label: "D25/D26" }
        album_internal_code: { cell: "M3:S3", merge: true, label: "M2" }
        cover_revision:      { cell: "M5", write_mode: "append_after_label", label: "Rev.:" }
        doc_status:          { cell: "P5", write_mode: "append_after_label", label: "Status:", source: "doc_status", note: "来源为001图纸的status值" }
        册次:                { cell: "M4", fixed: true, note: "Vol. x of y，模板固定值" }
        # 注：密级(classification)无需程序写入封面
      
      # 标题分割规则说明
      split_rules:
        cn_split_prefer_right_is_cjk_near_half:
          desc: "中文分割规则：尽量对半分到两格"
          rules:
            - "分割点必须满足：右侧字符为中文(CJK)"
            - "允许左侧为非中文且右侧为中文"
            - "禁止在纯英文/数字/符号序列中间分割"
        en_split_on_whitespace_between_words_near_half:
          desc: "英文分割规则：仅在完整单词之间分割"
          rules:
            - "仅允许在空白处分割"
            - "尽量对半分"
            - "优先选择分割后右侧以字母开头的单词"
          example: "'...~-8.800m secondary steel shop drawings' -> I23='...~-8.800m', I24='secondary steel shop drawings'"

    # --- 目录落点 ---
    catalog_bindings:
      header:
        engineering_no:        { cell: "C1", label: "A1" }
        catalog_internal_code: { cell: "H1", merge: "H1:I2(仅1818)" }
        catalog_external_code: { cell: "H3", merge: "H3:I4(仅1818)" }
        subitem_no:            { cell: "C5", merge: "C5:C6(仅1818)" }
        catalog_revision:      { cell: "H5", merge: "H5:H6(仅1818)" }
      
      detail:
        start_row: 9
        columns:
          A: { name: "序号",      source: "auto_increment" }
          B: { name: "图纸编号",  source: "internal_code", merge: "B:C" }
          D: { name: "文件编码",  source: "external_code" }
          E: { name: "名称",      source: "title_cn" }
          F: { name: "版次",      source: "revision" }
          G: { name: "状态",      source: "status" }
          H: { name: "页数",      source: "page_total" }
          I: { name: "附注",      source: "upgrade_note" }
        
        row_order: ["封面", "目录", "001~XXX图纸(按internal_code尾号升序)"]
        
        # 各行字段来源差异说明
        row_specific_sources:
          封面行:
            internal_code: "cover_internal_code"
            external_code: "cover_external_code"
            title_cn: "cover_title_cn"
            title_en: "cover_title_en"      # 仅1818：同一单元格内写入，格式为 title_cn + '\\n' + title_en
            revision: "cover_revision"
            status: "doc_status"            # 取001图纸status
            page_total: 1                   # 固定值
          目录行:
            internal_code: "catalog_internal_code"
            external_code: "catalog_external_code"
            title_cn: "catalog_title_cn"
            title_en: "catalog_title_en"    # 仅1818：同一单元格内写入，格式为 title_cn + '\\n' + title_en
            revision: "catalog_revision"
            status: "doc_status"            # 取001图纸status
            page_total: "catalog_page_total"  # 由PDF计页得到
          图纸行:
            internal_code: "frames[].titleblock.internal_code"
            external_code: "frames[].titleblock.external_code"
            title_cn: "frames[].titleblock.title_cn"
            title_en: "frames[].titleblock.title_en"  # 仅1818：同一单元格内写入
            revision: "frames[].titleblock.revision"
            status: "frames[].titleblock.status"
            page_total: "frames[].titleblock.page_total"  # 若无则默认1
        
        # 1818项目名称列特殊处理
        title_1818_format:
          desc: "1818项目目录E列需要在同一单元格内写入中英文标题"
          format: "{title_cn}\\n{title_en}"
          note: "换行符分隔，需设置单元格自动换行"
        
        upgrade_note_rule: "当internal_code尾号在[upgrade_start_seq, upgrade_end_seq]范围内时写入upgrade_note_text"
      
      pagination:
        paper_size: "A4横向"
        scale: 94-95
        print_titles: "$1:$8"
        page_count_method: "优先使用Excel分页信息计页，回填H列后仅导出一次PDF；不稳定时回退为“导出PDF计页→回填→再导出”"

    # --- 设计文件落点（A~Z列） ---
    design_bindings:
      start_row: 2
      columns:
        A:  { name: "状态",         source: "design_status",       global: true }
        B:  { name: "WBS编码",      source: "wbs_code",            global: true }
        C:  { name: "所属图册编码", source: "album_internal_code", global: true }
        D:  { name: "文件编码",     source: "external_code" }
        E:  { name: "内部编码",     source: "internal_code" }
        F:  { name: "版本",         source: "revision" }
        G:  { name: "中文标题",     source: "title_cn",            cover_catalog: "[cover/catalog]_title_cn" }
        H:  { name: "英文标题",     source: "title_en",            when: "1818", cover_catalog: "[cover/catalog]_title_en" }
        I:  { name: "内部标识",     source: "internal_tag",        global: true }
        J:  { name: "子项名称",     source: "subitem_name",        global: true }
        K:  { name: "子项号",       source: "subitem_no",          global: true }
        L:  { name: "系统代码",     source: "system_code",         global: true }
        M:  { name: "系统名称",     source: "system_name",         global: true }
        N:  { name: "专业(工种)",   source: "discipline",          cover_catalog: "取001图纸专业" }
        O:  { name: "专业代码",     source: "discipline_code_map[discipline]" }
        P:  { name: "专业室",       source: "discipline_office",   global: true }
        Q:  { name: "设计阶段",     source: "design_phase" }
        R:  { name: "密级",         source: "classification",      global: true }
        S:  { name: "图幅",         source: "paper_size_text",     cover_catalog: "A4文件" }
        T:  { name: "总页数",       source: "page_total",          cover: 1, catalog: "catalog_page_total" }
        U:  { name: "文件类别",     source: "file_category",       global: true }
        V:  { name: "图纸文件状态", source: "status",              cover_catalog: "取001图纸status" }
        W:  { name: "附件名称",     source: "attachment_name",     global: true }
        X:  { name: "是否质保核查", source: "qa_required",         global: true }
        Y:  { name: "质保核查工程师", source: "qa_engineer",       global: true }
        Z:  { name: "实际工时数",   source: "work_hours",          global: true }

    # --- IED计划落点（A~BW列，仅列出非空列） ---
    ied_bindings:
      sheet: "IED导入模板 (修改)"
      start_row: 2
      columns:
        # === 基本信息 ===
        A:  { name: "新增标记",     value: "A" }
        B:  { name: "变更标记",     source: "ied_change_flag",        global: true }
        C:  { name: "文档类型",     source: "ied_doc_type",           global: true }
        D:  { name: "IED状态",      source: "ied_status",             global: true }
        E:  { name: "WBS编码",      source: "wbs_code",               global: true }
        F:  { name: "所属图册编码", source: "album_internal_code",    global: true }
        G:  { name: "文件编码",     source: "external_code",          cover_catalog: "[cover/catalog]_external_code" }
        H:  { name: "原文件编码",   value: "" }
        I:  { name: "内部编码",     source: "internal_code",          cover_catalog: "[cover/catalog]_internal_code" }
        J:  { name: "版本",         source: "revision",               cover: "cover_revision", catalog: "catalog_revision" }
        K:  { name: "中文标题",     source: "title_cn",               cover_catalog: "[cover/catalog]_title_cn" }
        L:  { name: "英文标题",     source: "title_en",               when: "1818" }
        M:  { name: "人员资格类别", source: "ied_person_qual_category", global: true }
        
        # === 计划日期 ===
        N:  { name: "所提交计划",   source: "ied_submitted_plan_date", global: true }
        O:  { name: "计划会签日期", value: "" }
        P:  { name: "出版计划",     source: "ied_publish_plan_date",   global: true }
        Q:  { name: "外部计划",     source: "ied_external_plan_date",  global: true }
        R:  { name: "FU标记",       source: "ied_fu_flag",             global: true }
        S:  { name: "FU计划",       source: "ied_fu_plan_date",        global: true }
        T:  { name: "计划调整依据", value: "" }
        
        # === 标识与类型 ===
        U:  { name: "内部标识",     source: "ied_internal_tag",        global: true }
        V:  { name: "设计类型",     source: "ied_design_type",         global: true }
        W:  { name: "责任设总",     source: "ied_chief_designer",      global: true }
        X:  { name: "责任单位",     source: "ied_responsible_unit",    global: true }
        Y:  { name: "是否联合编审", value: "否" }
        
        # === Z~AS: 固定留空（完整列表） ===
        Z:  { name: "章节号",       value: "" }
        AA: { name: "章节名称",     value: "" }
        AB: { name: "SSC编码",      value: "" }
        AC: { name: "是否更新SSC关联", value: "" }
        AD: { name: "机组",         value: "" }
        AE: { name: "系统代码",     value: "" }
        AF: { name: "安装厂房",     value: "" }
        AG: { name: "安装层位及标高", value: "" }
        AH: { name: "安装区域",     value: "" }
        AI: { name: "安装层位",     value: "" }
        AJ: { name: "岛别",         value: "" }
        AK: { name: "土建厂房代码", value: "" }
        AL: { name: "土建分区",     value: "" }
        AM: { name: "土建层位及标高", value: "" }
        AN: { name: "土建区域",     value: "" }
        AO: { name: "房间",         value: "" }
        AP: { name: "模块",         value: "" }
        AQ: { name: "设备代码",     value: "" }
        AR: { name: "总体性文件",   value: "" }
        AS: { name: "相关物项类别", value: "" }
        
        # === 工时与验证 ===
        AT: { name: "计划工时",     source: "work_hours",              global: true }
        AU: { name: "是否验证",     value: "" }
        AV: { name: "验证方法",     value: "" }
        AW: { name: "验证人",       value: "" }
        AX: { name: "验证日期",     value: "" }
        
        # === 编审链 ===
        AY: { name: "编制者",       source: "ied_prepared_by",         global: true }
        AZ: { name: "第二编制者",   source: "ied_prepared_by_2",       global: true }
        BA: { name: "编制日期",     source: "ied_prepared_date",       global: true }
        BB: { name: "校核者",       source: "ied_checked_by",          global: true }
        BC: { name: "校核日期",     source: "ied_checked_date",        global: true }
        BD: { name: "工种负责人",   source: "ied_discipline_leader",   global: true }
        BE: { name: "工种负责人审核日期", source: "ied_discipline_leader_date", global: true }
        BF: { name: "审核者",       source: "ied_reviewed_by",         global: true }
        BG: { name: "审核日期",     source: "ied_reviewed_date",       global: true }
        BH: { name: "审定者",       source: "ied_approved_by",         global: true }
        BI: { name: "审定日期",     source: "ied_approved_date",       global: true }
        BJ: { name: "专业室",       source: "ied_discipline_office",   global: true }
        BK: { name: "密级",         source: "classification",          global: true }
        
        # === BL~BW: 固定留空（完整列表） ===
        BL: { name: "所提交计划原因", value: "" }
        BM: { name: "出版计划原因",   value: "" }
        BN: { name: "外部计划原因",   value: "" }
        BO: { name: "预估图纸量",     value: "" }
        BP: { name: "原定费用(元)",   value: "" }
        BQ: { name: "计划WR日期",     value: "" }
        BR: { name: "是否三维模型",   value: "" }
        BS: { name: "是否交付数据",   value: "" }
        BT: { name: "数据类型",       value: "" }
        BU: { name: "EM包",           value: "" }
        BV: { name: "安装大类",       value: "" }
        BW: { name: "责任系统",       value: "" }

  # --------------------------------------------------------------------------
  # 2.5 每张图元数据结构
  # --------------------------------------------------------------------------
  frame_meta:
    # 运行期字段（DXF流水线生成）
    runtime:
      frame_id:          { type: str, required: true, desc: "图框实例唯一ID" }
      drawing_group_key: { type: str, required: false, desc: "图纸级分组键（占位）：用于把多个frame归并为同一图纸/页，建议由internal_code+page_index组合生成" }
      source_file:       { type: str, required: true, desc: "来源DWG文件路径" }
      paper_variant_id:  { type: str, required: true, desc: "匹配的标准图幅ID(如CNPE_A1)" }
      sx:                { type: float, required: true, desc: "X方向缩放因子" }
      sy:                { type: float, required: true, desc: "Y方向缩放因子" }
      geom_scale_factor: { type: float, required: false, desc: "几何缩放因子，由(sx+sy)/2计算，用于与图签比例对比" }
      roi_profile_id:    { type: str, required: true, desc: "使用的ROI配置(BASE10/SMALL5)" }
      scale_mismatch:    { type: bool, required: false, desc: "几何缩放与图签比例是否不一致" }
      flags:             { type: "list[str]", required: false, desc: "告警标记列表" }
      pdf_path:          { type: str, required: true, desc: "输出PDF路径" }
      dwg_path:          { type: str, required: false, desc: "输出DWG路径" }

    # 图签字段（从DXF ROI提取）
    titleblock:
      internal_code:     { type: str, required: true,  desc: "内部编码(XXXXXXX-XXXXX-XXX)" }
      external_code:     { type: str, required: true,  desc: "外部编码(19位)" }
      album_code:        { type: str, required: false, desc: "图册编号(从internal_code中间5位末2位提取，不新增ROI)" }
      engineering_no:    { type: str, required: true,  desc: "工程号(4位)" }
      subitem_no:        { type: str, required: true,  desc: "子项号" }
      paper_size_text:   { type: str, required: true,  desc: "图幅(A0/A1/A2等)" }
      discipline:        { type: str, required: true,  desc: "专业" }
      scale_text:        { type: str, required: true,  desc: "比例(1:X)" }
      scale_denominator: { type: float, required: false, desc: "由scale_text解析得到的分母X，用于与geom_scale_factor对比" }
      page_total:        { type: int, required: false, desc: "共N张" }
      page_index:        { type: int, required: false, desc: "第M张" }
      title_cn:          { type: str, required: true,  desc: "中文标题" }
      title_en:          { type: str, required: false, desc: "英文标题(仅1818)" }
      revision:          { type: str, required: true,  desc: "版次" }
      status:            { type: str, required: true,  desc: "状态" }
      date:              { type: str, required: false, desc: "日期" }

# ============================================================================
# 三、图签提取模块 (titleblock_extract)
# ============================================================================
titleblock_extract:
  description: |
    图签提取模块负责从 DXF 中识别图框、提取图签字段。
    采用 rb_offset 坐标系（相对于图框右下角），支持任意比例图框。

  # --------------------------------------------------------------------------
  # 3.1 处理流水线
  # --------------------------------------------------------------------------
  pipeline:
    - { step: 1, name: "dwg_to_dxf",     desc: "DWG转DXF(ODA File Converter)" }
    - { step: 2, name: "frame_detect",   desc: "图框候选检测(闭合矩形/LINE重建)" }
    - { step: 3, name: "frame_verify",   desc: "锚点ROI验证(本文件产权属中国核电工程有限公司（CNPE）所有，未经书面许可，不得以任何方式复制、传播、发表和外传。)" }
    - { step: 4, name: "scale_check",    desc: "比例一致性检查(几何缩放vs图签比例)" }
    - { step: 5, name: "field_extract",  desc: "字段ROI提取与解析" }

  # --------------------------------------------------------------------------
  # 3.2 核心原则
  # --------------------------------------------------------------------------
  principles:
    production_has_no_calibration_layers: true  # 生产环境无标定图层
    roi_coordinate_system: "rb_offset_scaled"   # ROI坐标相对于右下角，按比例缩放

    # rb_offset 定义（基于1:1标定，运行时按sx/sy缩放）
    rb_offset_formula:
      dx_right:  "outer_xmax - roi_xmax"
      dx_left:   "outer_xmax - roi_xmin"
      dy_bottom: "roi_ymin - outer_ymin"
      dy_top:    "roi_ymax - outer_ymin"

    # ROI 还原公式
    roi_restore_formula:
      xmin: "outer_xmax - dx_left  * sx"
      xmax: "outer_xmax - dx_right * sx"
      ymin: "outer_ymin + dy_bottom * sy"
      ymax: "outer_ymin + dy_top    * sy"

  # --------------------------------------------------------------------------
  # 3.3 图幅标准尺寸
  # --------------------------------------------------------------------------
  paper_variants:
    # 大图幅（使用 BASE10 ROI profile）
    CNPE_A0:       { W: 1189.0, H: 841.0,  profile: BASE10 }
    CNPE_A0+1/2:   { W: 1784.0, H: 841.0,  profile: BASE10 }
    CNPE_A0+1/4:   { W: 1487.0, H: 841.0,  profile: BASE10 }
    CNPE_A0+1/8:   { W: 1338.0, H: 841.0,  profile: BASE10 }
    CNPE_A0H:      { W: 841.0,  H: 1189.0, profile: BASE10 }
    CNPE_A1:       { W: 841.0,  H: 594.0,  profile: BASE10 }
    CNPE_A1+1/1:   { W: 1682.0, H: 594.0,  profile: BASE10 }
    CNPE_A1+1/2:   { W: 1261.0, H: 594.0,  profile: BASE10 }
    CNPE_A1+1/4:   { W: 1051.0, H: 594.0,  profile: BASE10 }
    CNPE_A1H:      { W: 594.0,  H: 841.0,  profile: BASE10 }
    CNPE_A2:       { W: 594.0,  H: 420.0,  profile: BASE10 }
    CNPE_A2H:      { W: 420.0,  H: 594.0,  profile: BASE10 }
    CNPE_A2+1/2:   { W: 891.0,  H: 420.0,  profile: BASE10 }
    # 小图幅（使用 SMALL5 ROI profile）
    CNPE_A3:       { W: 420.0,  H: 297.0,  profile: SMALL5 }
    CNPE_A4:       { W: 210.0,  H: 297.0,  profile: SMALL5 }

  # --------------------------------------------------------------------------
  # 3.4 外框识别配置
  # --------------------------------------------------------------------------
  outer_frame:
    preferred_entities: ["LWPOLYLINE(closed)", "POLYLINE(closed)"]
    fallback: "LINE重建矩形"
    acceptance:
      min_area_rank: "按面积排序取top-N"
      orthogonality_tol_deg: 1.0
    multi_frame_per_dxf: true

  # --------------------------------------------------------------------------
  # 3.5 比例拟合配置
  # --------------------------------------------------------------------------
  scale_fit:
    allow_rotation: false
    uniform_scale_required: true
    uniform_scale_tol: 0.02  # 2%
    fit_error_metric: "max_rel_error(W,H)"
    outputs: [paper_variant_id, sx, sy, geom_scale_factor]

  # --------------------------------------------------------------------------
  # 3.6 ROI Profile 定义
  # --------------------------------------------------------------------------
  # rb_offset 格式: [dx_right, dx_left, dy_bottom, dy_top]
  roi_profiles:
    BASE10:
      description: "大图幅标准版图签(dx_right≈10)"
      tolerance: 0.5
      # 外层矩形用于参考/校验，格式同rb_offset
      outer_frame:  [0.0, 1189.0, 0.0, 841.0]
      fields:
        工程号:     [96.0,  116.0, 42.0, 52.0]
        子项号:     [64.0,  84.0,  42.0, 52.0]
        内部编码:   [10.0,  52.0,  42.0, 52.0]
        外部编码:   [10.2,  190.2, 84.0, 94.0]
        图幅:       [10.1,  26.0,  34.0, 42.0]
        专业:       [10.1,  26.0,  26.0, 34.0]
        比例:       [10.0,  26.0,  18.0, 26.0]
        张数:       [10.0,  38.0,  10.0, 18.0]
        图纸标题:   [38.0,  128.0, 10.0, 42.0]
        版次:       [178.2, 190.0, 118.0, 141.8]
        状态:       [144.2, 160.2, 118.0, 141.8]
        日期:       [160.2, 178.2, 118.0, 141.8]
        锚点:       [10.0,  190.0, 68.0, 84.0]

    SMALL5:
      description: "小图幅紧凑版图签(A3/A4，dx_right≈5)"
      tolerance: 0.5
      outer_frame:  [0.0, 420.0, 0.0, 297.0]
      fields:
        工程号:     [91.0,  111.0, 37.0, 47.0]
        子项号:     [59.0,  79.0,  37.0, 47.0]
        内部编码:   [5.0,   47.0,  37.0, 47.0]
        外部编码:   [5.2,   185.2, 79.0, 89.0]
        图幅:       [5.1,   21.0,  29.0, 37.0]
        专业:       [5.1,   21.0,  21.0, 29.0]
        比例:       [5.0,   21.0,  13.0, 21.0]
        张数:       [5.0,   33.0,  5.0,  13.0]
        图纸标题:   [33.0,  123.0, 5.0,  37.0]
        版次:       [173.2, 185.0, 113.0, 136.8]
        状态:       [139.2, 155.2, 113.0, 136.8]
        日期:       [155.2, 173.2, 113.0, 136.8]
        锚点:       [100.6, 183.2, 73.6, 76.8]

  # --------------------------------------------------------------------------
  # 3.7 字段解析规则
  # --------------------------------------------------------------------------
  field_definitions:
    external_code:
      roi: 外部编码
      parse:
        type: docno_fixed19
        header: "DOC.NO"
        charset: "A-Z0-9"
        length: 19

    internal_code:
      roi: 内部编码
      parse:
        type: regex_multi
        patterns:
          full:  "^(?P<prefix>[A-Z0-9]{7})-(?P<mid>[A-Z0-9]{5})-(?P<seq>[0-9]{3})$"
          short: "^(?P<prefix>[A-Z0-9]{7})-(?P<mid>[A-Z0-9]{5})$"
          mid_album: "^(?P<mid3>[A-Z0-9]{3})(?P<album>[0-9]{2})$"
        note: "mid_album用于从mid字段的末2位提取album_code(图册编号)"

    engineering_no:
      roi: 工程号
      parse: { type: regex, pattern: "^[0-9]{4}$" }

    subitem_no:
      roi: 子项号
      parse: { type: text_or_lexicon }

    paper_size_text:
      roi: 图幅
      parse: { type: text }

    discipline:
      roi: 专业
      parse: { type: text }

    scale_text:
      roi: 比例
      parse:
        type: regex
        pattern: "^1[:：](\\d+(?:\\.\\d+)?)$"
        output: { scale_denominator: 1 }

    page_info:
      roi: 张数
      parse:
        type: page_info_auto
        pattern: "共\\s*(\\d+)\\s*张.*第\\s*([0-9Xx]+)\\s*张"
        output: { page_total: 1, page_index: 2 }
        note: "支持整句匹配和双数字token解析"

    title:
      roi: 图纸标题
      parse:
        type: bilingual_split
        rules:
          - "按y坐标聚类成行"
          - "含CJK字符的行归为中文候选"
          - "纯英文/数字行归为英文候选"
          - "中文候选拼接为title_cn"
          - "英文候选拼接为title_en"

    revision:
      roi: 版次
      parse:
        type: pick_top_by_y
        note: "修订表列内取y值最大的文本"

    status:
      roi: 状态
      parse: { type: pick_top_by_y }

    date:
      roi: 日期
      parse: { type: pick_top_by_y }

  # --------------------------------------------------------------------------
  # 3.8 锚点检测配置
  # --------------------------------------------------------------------------
  anchor:
    search_text: ["本文件产权属中国核电工程有限公司（CNPE）所有，未经书面许可，不得以任何方式复制、传播、发表和外传。"]
    profile_priority: [BASE10, SMALL5]
    match_policy: "single_hit_same_roi"
    roi_field_name: "锚点"

  # --------------------------------------------------------------------------
  # 3.9 容差配置
  # --------------------------------------------------------------------------
  tolerances:
    roi_margin_percent: 0.02
    text_grouping:
      y_cluster_abs: 1.0
      line_join: "\n"
    scale_mismatch:
      abs_tol: 0.5
      rel_tol: 0.02
      flag_name: "比例不一致"
      continue_on_mismatch: true

  # --------------------------------------------------------------------------
  # 3.10 数值精度策略
  # --------------------------------------------------------------------------
  numeric_precision_policy:
    float_round_decimals: 3
    desc: "本文件中的标定/ROI数值已按3位小数保存"
    notes:
      - "算法实现可用float计算"
      - "容差以tolerance/roi_profiles.tolerance等字段为准"
      - "坐标比较时建议使用abs(a-b) < epsilon，epsilon取0.001或更小"

# ============================================================================
# 四、A4多页特殊处理规则
# ============================================================================
a4_multipage:
  description: |
    处理同一DXF内多张A4说明页(001)的情况，仅第1张有完整图签，
    其余页只有外框和右上角页码。约占实际场景80%。

  # --------------------------------------------------------------------------
  # 4.1 触发条件
  # --------------------------------------------------------------------------
  trigger_conditions:
    - "检测到≥2个A4外框属于同一空间簇"
    - "簇内存在至少1个Master Page(带锚点和图签)"
    - "Master Page关键字段命中数≥3(工程号/内外部编码/张数)"

  # --------------------------------------------------------------------------
  # 4.2 A4判定与簇构建
  # --------------------------------------------------------------------------
  a4_detection:
    # A4标准尺寸
    canonical_size:
      portrait:  { W: 210, H: 297 }
      landscape: { W: 297, H: 210 }
    
    # 拟合误差计算公式
    fit_error_formula: "max(|sx-geom_scale|, |sy-geom_scale|) / max(geom_scale, 1e-9)"
    uniform_scale_tol: 0.02  # 2%
    
    # 判定输出
    outputs: [paper, orientation, sx, sy, geom_scale]

  cluster_building:
    desc: "把同一DXF中所有A4外框作为节点，按间距连边，取连通分量"
    gap_threshold_formula: "gap_threshold_factor * min(W_obs, H_obs)"
    gap_threshold_factor: 1.0
    edge_rule: "min_dx < gap_threshold AND min_dy < gap_threshold"

  # --------------------------------------------------------------------------
  # 4.3 Master Page定位
  # --------------------------------------------------------------------------
  master_page:
    detection:
      - "锚点ROI命中(本文件产权属中国核电工程有限公司（CNPE）所有，未经书面许可，不得以任何方式复制、传播、发表和外传。)"
      - "关键字段命中数≥3(工程号/内部编码/外部编码/张数)"
    selection_priority:
      - "字段命中数量最多"
      - "能解析出page_total且page_index=1"

  # --------------------------------------------------------------------------
  # 4.4 Slave Page页码识别
  # --------------------------------------------------------------------------
  slave_page:
    # 方法1：固定ROI（优先）
    page_marker_roi:
      description: "右上角页码标记区域(1:1初始值)"
      rb_offset: [0.0, 120.0, 255.0, 295.0]  # [dx_right, dx_left, dy_bottom, dy_top]
    pattern: "共\\s*(\\d+)\\s*张\\s*第\\s*(\\d+)\\s*张"
    
    # 方法2：位置评分兜底（ROI未命中时）
    fallback_scoring:
      desc: "在外框内搜索候选文本，按归一化位置评分"
      filter:
        xnorm_min: 0.60  # xnorm = (x-xmin)/W_obs
        ynorm_min: 0.85  # ynorm = (y-ymin)/H_obs
      score_formula: "2*xnorm + 2*ynorm + bonus"
      bonus: { pattern_hit: 1, otherwise: 0 }  # 命中"第N张"正则加1分
      selection: "取最高分"

  # --------------------------------------------------------------------------
  # 4.5 元数据继承与回填
  # --------------------------------------------------------------------------
  metadata:
    inheritance: "整组sheet-set的元数据默认取自Master(标题栏提取结果)"
    fields_from_master:
      - engineering_no
      - subitem_no
      - internal_code
      - external_code
      - discipline
      - title_cn
      - title_en
      - revision
      - status
      - date
      - scale_text
    missing_master_fields_policy: "error"
    missing_master_fields_flag: "A4多页_Master缺关键字段"

  # --------------------------------------------------------------------------
  # 4.6 一致性校验
  # --------------------------------------------------------------------------
  consistency_checks:
    - { check: "cluster内A4外框数 != page_total", flag: "A4多页_页数不一致" }
    - { check: "页码重复",                        flag: "A4多页_页码重复" }
    - { check: "页码不连续(如1,2,4缺3)",          flag: "A4多页_页码不连续" }
    - { check: "Slave的page_total与Master不一致", flag: "A4多页_页总数冲突" }
    - { check: "page_index_master != 1",          flag: "A4多页_首页页码异常" }
  policy: "不中断运行，继续裁切输出"

  # --------------------------------------------------------------------------
  # 4.7 裁切输出
  # --------------------------------------------------------------------------
  clipping:
    desc: "保持各A4外框相对位置不变"
    margin:
      formula: "outer_bbox ± margin"
      margin_percent: "1%~2%，随W_obs/H_obs自适应"
    entity_rule: "实体bbox与任一clip_bbox相交则保留"
    coordinate_rule: "不做平移/不归零坐标，保持原始坐标"

  # --------------------------------------------------------------------------
  # 4.8 PDF输出
  # --------------------------------------------------------------------------
  output:
    pdf:
      preferred: "多页PDF(每个A4外框一页，按page_index排序)"
      method: "逐页窗口打印(plot window = outer_bbox)，再合并"
    fallback:
      condition: "无法合并多页"
      method: "以cluster的union bbox打印extents，生成单页大图PDF"
      flag: "A4多页_PDF兜底为单页大图"
    dwg: "保持各A4外框相对位置不变"

  # --------------------------------------------------------------------------
  # 4.9 中间结果结构
  # --------------------------------------------------------------------------
  result_structure:
    example:
      sheet_set_type: "A4_MULTI_PAGE_001"
      paper: "A4"
      cluster_id: "uuid"
      page_total: 7
      master_page:
        outer_bbox: [xmin, ymin, xmax, ymax]
        extracted_fields: { "...": "..." }
      pages:
        - { page_index: 1, outer_bbox: [], has_titleblock: true }
        - { page_index: 2, outer_bbox: [], has_titleblock: false }
      flags: ["比例不一致", "A4多页_页码不连续"]
