schema_version: "1.0"
name: "参数规范（合并版）"
source_of_truth: true
notes:
  - "本文件将两类规范合并在同一个 YAML 内，但以分区方式保存："
  - "- sections.doc_generation_spec：文档生成模块的业务参数规范（前端/后端/模板落点/派生规则）"
  - "- sections.titleblock_extraction_spec：CNPE DWG/DXF 图框识别 + 图签字段提取运行配置（ROI/解析/流水线）"
  - "不要将两者扁平混合为同一层字段：两者生命周期不同（一个随业务表单/模板演进，一个随图签/ROI标定演进）。"
  - "兼容性：doc_generation_spec 中很多 source 仍以字符串 'CNPE.field_definitions.xxx' 表示来源；在本合并文件中，CNPE 对应 sections.titleblock_extraction_spec。"

sections:
  doc_generation_spec:
    schema_version: "1.0"
    name: "文档生成模块参数规范（结构化版本）"
    source_of_truth: true
    notes:
      - "建议：前端表单/后端校验/生成 manifest 均以本 YAML 为准；Markdown 仅作为可读说明。"

    enums:
      ProjectNo:
        - "1818"
        - "2016"
        - "2026"
        - "1916"
        - "1907"
        - "2035"
        - "1418"
      PdfEngine:
        - "office_com"
        - "libreoffice"
      CoverVariant:
        - "通用"
        - "压力容器"
        - "核安全设备"

    objects:
      DocContext:
        description: "文档生成模块的输入上下文（一次任务）"
        fields:
          project_no:
            type: "str"
            enum: "ProjectNo"
            required: true
            source: "frontend"
            description: "项目号：用于模板分支/词库匹配/规则分支"
          job_id:
            type: "str"
            required: true
            source: "system"
            description: "任务唯一标识（用于查进度/下载/追溯）"
          options:
            type: "DocOptions"
            required: true
            source: "frontend"
          user_params:
            type: "GlobalDocParams"
            required: true
            source: "frontend+derived+dxf"
          frames:
            type: "list[FrameMeta]"
            required: true
            source: "dxf_pipeline"

      DocOptions:
        description: "文档生成开关与 PDF 导出策略"
        fields:
          enabled:
            type: "bool"
            required: true
            default: true
            source: "frontend"
            description: "总开关：true 时封面/目录/设计文件/IED 全部生成并输出"
          export_pdf:
            type: "bool"
            required: true
            default: true
            source: "frontend"
            description: "是否导出 PDF（你已确认必须）"
          pdf_engine:
            type: "str"
            enum: "PdfEngine"
            required: true
            default: "office_com"
            source: "frontend"
            description: "Word/Excel 导出 PDF 的实现方式（含 OLE 时推荐 Office COM）"
          pdf_margin:
            type: "dict"
            required: true
            source: "frontend"
            description: "DWG/DXF 打印 PDF 的页边距（上下左右），单位需约定（mm 或 inch）"
            example:
              top_mm: 0
              bottom_mm: 0
              left_mm: 0
              right_mm: 0

      GlobalDocParams:
        description: "全局参数（整本图册/整次任务共用）"
        fields:
          project_no:
            type: "str"
            enum: "ProjectNo"
            required: true
            source: "frontend"
          cover_variant:
            type: "str"
            enum: "CoverVariant"
            required_when: "project_no != '1818'"
            source: "frontend"
            description: "非 1818 的封面模板选择"
          classification:
            type: "str"
            required: true
            source: "frontend"
            description: "密级：写入封面/设计文件/IED"
          approved_by:
            type: "str"
            required: false
            source: "frontend"
            deprecated: true
            description: "封面批准人：已确认取消，不读取也不编辑（保留字段仅为兼容旧表单）"
          engineering_no:
            type: "str"
            required: true
            source: "dxf:titleblock.engineering_no"
            description: "工程号：来自 DXF 图签“工程号”"
          subitem_no:
            type: "str"
            required: true
            source: "dxf:titleblock.subitem_no"
            description: "子项号：来自 DXF 图签“子项号”（用于封面/目录）"
          system_code:
            type: "str"
            required: false
            default: "NA"
            source: "frontend"
            description: "系统代码：前端输入（默认 NA）；用于设计文件与 IED（对应模板列“系统代码”）"
          system_name:
            type: "str"
            required: false
            default: "NA"
            source: "frontend"
            description: "系统名称：前端输入（默认 NA）；用于设计文件（对应模板列“系统名称”）"
          subitem_name:
            type: "str"
            required: true
            source: "mapping:subitem_no_to_subitem_name"
            description: "子项名称：由子项号查对照表得到"
          doc_status:
            type: "str"
            required: true
            source: "dxf:titleblock.status"
            description: "状态：来自 DXF 图签“状态”"
          design_phase:
            type: "str"
            required: true
            source: "derived:status_to_design_phase"
            description: "设计阶段：从图签状态派生；当 status=CFC 时，design_phase 固定为“施工图设计”（与设计文件中的 design_phase 一致）"
          album_internal_code:
            type: "str"
            required: true
            source: "derived:internal_code_base_001"
            description: "图册编号（内部编码前缀）：取 001 图纸 internal_code 的前缀 XXXXXXX-XXXXX（不新增ROI）；用于封面 N3（合并 N3:S3）"
          album_code:
            type: "str"
            required: true
            source: "derived:album_code_001"
            description: "图册编号（末2位数字）：从内部编码中间5位末2位提取（不新增ROI）；用于封面 I25（合并 I25:S25）"
          cover_revision:
            type: "str"
            required: false
            default: "A"
            source: "frontend"
            description: "封面版次：前端输入（默认A），写入封面 N5（模板已有“版次：”，在后面追加）；与图签 revision 区分"
          upgrade_revision:
            type: "str"
            required: false
            source: "frontend"
            description: "升版版本：前端输入（例如 B/C）；用于目录页眉版次（catalog_revision）"
          catalog_revision:
            type: "str"
            required: true
            source: "derived:catalog_revision"
            description: "目录版次：用于目录页眉H5(Rev.)。规则：优先取前端升版版本 upgrade_revision；若未提供则默认取 cover_revision（默认A），保证用户不选升版版本时封面/目录均为A"
          discipline:
            type: "str"
            required: true
            source: "derived:discipline_001"
            description: "专业：用于封面/目录等全局落点，取 001 图纸的 DXF 图签“专业”（与封面/目录规则一致）"
          revision:
            type: "str"
            required: true
            source: "dxf:titleblock.revision"
            description: "版次：来自 DXF 图签“版次”"

          album_title:
            type: "str"
            required: false
            source: "frontend"
            deprecated: true
            description: "已废弃：旧字段。请使用 album_title_cn/album_title_en（前端输入）"
          album_title_cn:
            type: "str"
            required: true
            source: "frontend"
            description: "图册/文件名称（中文）：前端输入。通用封面与1818封面均写入I21(+I22联动分割)。也用于派生 cover_title_cn/catalog_title_cn。"
          album_title_en:
            type: "str"
            required_when: "project_no == '1818'"
            source: "frontend"
            description: "图册/文件名称（英文）：仅1818需要前端输入。写入1818封面I23(+I24联动分割)。也用于派生 cover_title_en/catalog_title_en。"
          cover_title_cn:
            type: "str"
            required: true
            source: "derived:cover_title_cn"
            description: "封面条目名称（中文）：album_title_cn + '封面'"
          catalog_title_cn:
            type: "str"
            required: true
            source: "derived:catalog_title_cn"
            description: "目录条目名称（中文）：album_title_cn + '目录'"
          cover_title_en:
            type: "str"
            required_when: "project_no == '1818'"
            source: "derived:cover_title_en"
            description: "封面条目名称（英文，仅1818）：album_title_en + ' Cover'"
          catalog_title_en:
            type: "str"
            required_when: "project_no == '1818'"
            source: "derived:catalog_title_en"
            description: "目录条目名称（英文，仅1818）：album_title_en + ' Contents'（如需更正式可改 ' Table of Contents'）"

          cover_paper_size_text:
            type: "str"
            required: true
            source: "derived:cover_paper_size_text"
            description: "封面文件图幅：固定为'A4文件'"
          cover_page_total:
            type: "int"
            required: true
            source: "derived:cover_page_total"
            description: "封面文件页数：固定为1"
          catalog_paper_size_text:
            type: "str"
            required: true
            source: "derived:catalog_paper_size_text"
            description: "目录文件图幅：固定为'A4文件'"
          catalog_page_total:
            type: "int"
            required: true
            source: "derived:catalog_page_total_from_pdf"
            description: "目录文件页数：按A4横向分页后导出PDF计页得到（见 template_bindings.catalog_common.* 的分页说明）"

          upgrade_start_seq:
            type: "int"
            required: false
            source: "frontend"
            description: "升版范围起始尾号（XXX）：例如 5 表示 005"
          upgrade_end_seq:
            type: "int"
            required: false
            source: "frontend"
            description: "升版范围结束尾号（XXX）：例如 12 表示 012"
          upgrade_note_text:
            type: "str"
            required: false
            default: "升版"
            source: "frontend"
            description: "升版标记写入文本：用于目录明细I列"
          cover_internal_code:
            type: "str"
            required: true
            source: "derived:internal_code_001_replace_suffix"
            description: "封面内部编码：取 001 图纸内部编码，把末段 -001 替换为 -FM"
          catalog_internal_code:
            type: "str"
            required: true
            source: "derived:internal_code_001_replace_suffix"
            description: "目录内部编码：取 001 图纸内部编码，把末段 -001 替换为 -TM"
          cover_external_code:
            type: "str"
            required: true
            source: "derived:external_code_001_replace_pos_9_11"
            description: "封面外部编码：取 001 图纸外部编码，把第 9~11 位替换为 F01"
          catalog_external_code:
            type: "str"
            required: true
            source: "derived:external_code_001_replace_pos_9_11"
            description: "目录外部编码：取 001 图纸外部编码，把第 9~11 位替换为 T01"

      FrameMeta:
        description: "每张图（每个图框拆分结果）的元数据"
        fields:
          frame_id:
            type: "str"
            required: true
            source: "system"
            description: "图框实例ID（一个图框=一条记录）；注意：后续可能存在多图框共属于同一张图纸，需引入图纸级聚合/分组逻辑（见 drawing_group_key 占位字段）"
          drawing_group_key:
            type: "str"
            required: false
            source: "derived:tbd"
            description: "图纸级分组键（占位）：用于把多个 frame 归并为同一“图纸/页”。建议未来由 internal_code + page_index (+ source_file) 等组合生成，具体规则后续补充"
          source_file:
            type: "str"
            required: true
            source: "ingest"
          paper_variant_id:
            type: "str"
            required: true
            source: "dxf:scale_fit.paper_variant_id"
          sx:
            type: "float"
            required: true
            source: "dxf:scale_fit.sx"
          sy:
            type: "float"
            required: true
            source: "dxf:scale_fit.sy"
          geom_scale_factor:
            type: "float"
            required: false
            source: "dxf:scale_fit.geom_scale_factor"
            description: "几何缩放因子（由 sx/sy 聚合得到，用于与图签比例文本对比）"
          roi_profile_id:
            type: "str"
            required: true
            source: "dxf:roi_profiles.selected"
          scale_mismatch:
            type: "bool"
            required: false
            source: "dxf:scale_consistency_check"
            description: "比例不一致布尔值：几何缩放(geom_scale_factor)与图签比例(scale_text->scale_denominator)超出容差时为 true；同时应写入 flags[]"
          flags:
            type: "list[str]"
            required: false
            source: "dxf:quality"

          titleblock:
            type: "TitleblockFields"
            required: true
            source: "dxf:titleblock"

          pdf_path:
            type: "str"
            required: true
            source: "system"
          dwg_path:
            type: "str"
            required: false
            source: "system"

      TitleblockFields:
        description: "DXF 图签字段（对齐 titleblock_extraction_spec / field_definitions）"
        fields:
          internal_code:
            type: "str"
            required: true
            source: "CNPE.field_definitions.internal_code"
            description: "内部编码：XXXXXXX-XXXXX-XXX，XXX 从 001 起"
          album_code:
            type: "str"
            required: false
            source: "CNPE.field_definitions.album_code"
            description: "图册编号：从内部编码的“中间5位”的末2位提炼（不新增ROI）。对两种 internal_code 格式都生效：XXXXXXX-XXXXX-XXX 与 XXXXXXX-XXXXX；要求末2位为数字。例如 20161NH-JGS01 -> album_code=01"
          external_code:
            type: "str"
            required: true
            source: "CNPE.field_definitions.external_code"
            description: "外部编码：19 位"
          engineering_no:
            type: "str"
            required: true
            source: "CNPE.field_definitions.engineering_no"
          subitem_no:
            type: "str"
            required: true
            source: "CNPE.field_definitions.subitem_no"
          paper_size_text:
            type: "str"
            required: true
            source: "CNPE.field_definitions.paper_size_text"
          discipline:
            type: "str"
            required: true
            source: "CNPE.field_definitions.discipline"
          scale_text:
            type: "str"
            required: true
            source: "CNPE.field_definitions.scale_text"
          scale_denominator:
            type: "float"
            required: false
            source: "CNPE.field_definitions.scale_text"
            description: "由 scale_text 解析得到的分母 X（1:X）；用于与 geom_scale_factor 做一致性比较"
          page_total:
            type: "int"
            required: false
            source: "CNPE.field_definitions.page_info"
          page_index:
            type: "int"
            required: false
            source: "CNPE.field_definitions.page_info"
          title_cn:
            type: "str"
            required: true
            source: "CNPE.field_definitions.title_cn"
          revision:
            type: "str"
            required: true
            source: "CNPE.field_definitions.revision"
          status:
            type: "str"
            required: true
            source: "CNPE.field_definitions.status"
          date:
            type: "str"
            required: false
            source: "CNPE.field_definitions.date"

    template_bindings:
      cover:
        external_code_19char_row29_B_to_T:
          template: "documents_bin/封面模板文件*.docx (embedded Excel)"
          location: "row=29, col=B..T (19 cells)"
          value_from: "GlobalDocParams.cover_external_code"
          note: "你已说明：第29行B列起连续19格用于输入19位外部编码"
        album_internal_code_merge_N3_S3:
          template: "documents_bin/封面模板文件*.docx (embedded Excel)"
          location: "N3:S3 (merged)"
          value_from: "GlobalDocParams.album_internal_code"
          note: "合并单元格写入规则：写入合并区左上角单元格即可（Excel仅存储左上角值）"
        album_code_digits_merge_I25_S25:
          template: "documents_bin/封面模板文件*.docx (embedded Excel)"
          location: "I25:S25 (merged)"
          value_from: "GlobalDocParams.album_code"
        cover_revision_merge_N5_P5_append:
          template: "documents_bin/封面模板文件*.docx (embedded Excel)"
          location: "N5:P5 (merged)"
          value_from: "GlobalDocParams.cover_revision"
          write_mode: "append_after_existing_label"
          note: "模板N5已有“版次：”，运行时读取原值并在其后追加 cover_revision；不影响图签 revision 字段"
        album_title_cn_split_I21_I22:
          template: "documents_bin/封面模板文件*.docx (embedded Excel)"
          location: "I21 + I22"
          value_from: "GlobalDocParams.album_title_cn"
          write_mode: "split_into_two_cells"
          split_rule: "cn_split_prefer_right_is_cjk_near_half"
          note: "I21/I22联动写入：为控制每格字数不溢出，将字符串尽量对半分；分割点必须满足“右侧字符为中文(CJK)”，允许左侧为非中文且右侧为中文；禁止在纯英文/数字/符号序列中间分割。"
      cover_1818:
        album_title_cn_split_I21_I22:
          template: "documents_bin/1818图册封面模板.docx (embedded Excel)"
          location: "I21 + I22"
          value_from: "GlobalDocParams.album_title_cn"
          write_mode: "split_into_two_cells"
          split_rule: "cn_split_prefer_right_is_cjk_near_half"
        album_title_en_split_I23_I24:
          template: "documents_bin/1818图册封面模板.docx (embedded Excel)"
          location: "I23 + I24"
          value_from: "GlobalDocParams.album_title_en"
          write_mode: "split_into_two_cells"
          split_rule: "en_split_on_whitespace_between_words_near_half"
          note: "I23/I24联动写入：英文仅允许在完整英文单词之间（空白处）分割；优先选择分割后右侧以字母开头的单词。示例：'...~-8.800m secongdary steel shop drawings' -> I23='...~-8.800m'，I24='secongdary steel shop drawings'"
        cover_revision_cell_M5_append:
          template: "documents_bin/1818图册封面模板.docx (embedded Excel)"
          location: "M5"
          value_from: "GlobalDocParams.cover_revision"
          write_mode: "append_after_existing_label"
          note: "1818封面M5单元格原值为'Rev.:'，因此写入cover_revision需做增量追加（例如写成'Rev.:A'）。"
      catalog_common:
        header_internal_code_tm:
          template: "documents_bin/目录模板文件.xlsx"
          sheet: "Sheet1"
          cell: "H1"
          value_from: "GlobalDocParams.catalog_internal_code"
        header_external_code_t01:
          template: "documents_bin/目录模板文件.xlsx"
          sheet: "Sheet1"
          cell: "H3"
          value_from: "GlobalDocParams.catalog_external_code"
        header_catalog_revision:
          template: "documents_bin/目录模板文件.xlsx"
          sheet: "Sheet1"
          cell: "H5"
          value_from: "GlobalDocParams.catalog_revision"
          note: "目录页眉版次：取catalog_revision（优先前端升版版本upgrade_revision）"
        detail_note_col_I:
          template: "documents_bin/目录模板文件.xlsx"
          sheet: "Sheet1"
          column: "I"
          start_row: 9
          value_from: "derived:catalog_detail_note_by_upgrade_range"
          note: "目录明细I列：仅对图纸行(001~XXX)生效；若internal_code尾号XXX落在前端升版范围[start_seq,end_seq]内，则写入 upgrade_note_text(默认'升版')，否则留空。封面/目录两行留空。"
        pagination:
          template: "documents_bin/目录模板文件.xlsx"
          sheet: "Sheet1"
          note: "分页事实：A4横向(paperSize=9, landscape), scale≈95；页眉包含'共&N页 第&P页'。生成时应将Print_Area动态更新为A1:I{last_row}并保持Print_Titles=1:8，先导出PDF计页得到catalog_page_total，再把该值回填到目录行(H列)并重新导出PDF，确保xlsx与pdf一致。"
      catalog_1818:
        header_catalog_revision:
          template: "documents_bin/1818图册目录模板.xlsx"
          sheet: "Sheet1"
          cell: "H5"
          value_from: "GlobalDocParams.catalog_revision"
        detail_note_col_I:
          template: "documents_bin/1818图册目录模板.xlsx"
          sheet: "Sheet1"
          column: "I"
          start_row: 9
          value_from: "derived:catalog_detail_note_by_upgrade_range"
        pagination:
          template: "documents_bin/1818图册目录模板.xlsx"
          sheet: "Sheet1"
          note: "分页事实：A4横向(paperSize=9, landscape), scale≈94；页眉包含'共&N页 第&P页'。1818目录E列为双语换行(title_cn+'\\n'+title_en)，会影响行高与分页；建议同catalog_common：动态设Print_Area后，先导出PDF计页得到catalog_page_total，再回填目录行(H列)并重新导出PDF。"
      ied:
        system_code_col_AE:
          template: "documents_bin/IED计划模板文件.xlsx"
          sheet: "IED导入模板 (修改)"
          column: "AE"
          value_from: "GlobalDocParams.system_code"
          default: "NA"
          note: "模板表头为“系统代码”；你已确认来源为前端输入（默认 NA）"

    derived_rules:
      internal_code_001:
        select: "frame where frames[].titleblock.internal_code endswith '-001'"
        from: "frames[].titleblock.internal_code"
      internal_code_base_001:
        from: "internal_code_001"
        transform: "strip_suffix('-001')"
        note: "内部编码前缀：对 XXXXXXX-XXXXX-001 取 XXXXXXX-XXXXX；若输入已是 XXXXXXX-XXXXX（无-001），则视为已是前缀"
      external_code_001:
        select: "frame where frames[].titleblock.internal_code endswith '-001'"
        from: "frames[].titleblock.external_code"
      discipline_001:
        select: "frame where frames[].titleblock.internal_code endswith '-001'"
        from: "frames[].titleblock.discipline"
        note: "全局专业（封面/目录使用）：取 001 图纸专业"
      cover_internal_code:
        from: "internal_code_001"
        transform: "replace_suffix('-001','-FM')"
      catalog_internal_code:
        from: "internal_code_001"
        transform: "replace_suffix('-001','-TM')"
      cover_external_code:
        from: "external_code_001"
        transform: "replace_pos_9_11('F01')"
        note: "按 1-based 计数，第9~11位替换；例：JD1NHT11001B25C42SD -> JD1NHT11F01B25C42SD"
      catalog_external_code:
        from: "external_code_001"
        transform: "replace_pos_9_11('T01')"
        note: "按 1-based 计数，第9~11位替换；例：JD1NHT11001B25C42SD -> JD1NHT11T01B25C42SD"
      album_code_001:
        select: "frame where frames[].titleblock.internal_code endswith '-001'"
        from: "frames[].titleblock.album_code"
      status_to_design_phase:
        from: "frames[].titleblock.status"
        transform: "map({'CFC':'施工图设计'}, default=status)"
      cover_title_cn:
        from: "GlobalDocParams.album_title_cn"
        transform: "append('封面')"
      catalog_title_cn:
        from: "GlobalDocParams.album_title_cn"
        transform: "append('目录')"
      cover_title_en:
        from: "GlobalDocParams.album_title_en"
        transform: "append(' Cover')"
      catalog_title_en:
        from: "GlobalDocParams.album_title_en"
        transform: "append(' Contents')"
      cover_paper_size_text:
        from: "literal"
        transform: "const('A4文件')"
      cover_page_total:
        from: "literal"
        transform: "const(1)"
      catalog_paper_size_text:
        from: "literal"
        transform: "const('A4文件')"
      catalog_page_total_from_pdf:
        from: "catalog_pdf"
        transform: "count_pdf_pages()"
        note: "实现建议：Office COM/LibreOffice导出目录PDF后，用 tools/pdf_page_count.py(pypdf) 计页得到catalog_page_total；然后把该值回填到目录明细“目录文件”这一行的H列并重新导出PDF。"
      catalog_revision:
        from: "GlobalDocParams.upgrade_revision"
        transform: "coalesce_nonempty(upgrade_revision, cover_revision)"
        note: "目录版次优先取前端升版版本；若未提供则取cover_revision（默认A），保证封面/目录默认一致。"
      catalog_detail_note_by_upgrade_range:
        from: "frames[].titleblock.internal_code"
        transform: "if(seq_in_range(upgrade_start_seq, upgrade_end_seq), upgrade_note_text, '')"
        note: "seq_in_range：从internal_code取末段-XXX为整数；仅对图纸行使用。"

  titleblock_extraction_spec:
    schema_version: "2.0"
    project: CNPE_DWG_DXF_Titleblock_Extraction
    principle:
      production_has_no_calibration_layers: true
      roi_primary_coordinate_system: rb_offset_scaled
      rb_offset_definition:
        dx_right: outer_xmax - roi_xmax
        dx_left: outer_xmax - roi_xmin
        dy_bottom: roi_ymin - outer_ymin
        dy_top: roi_ymax - outer_ymin
      roi_restore_formula:
        xmin: outer_xmax - dx_left * sx
        xmax: outer_xmax - dx_right * sx
        ymin: outer_ymin + dy_bottom * sy
        ymax: outer_ymin + dy_top * sy
      note: rb_offset 中的数值来自 1:1 标准图框标定；运行时需按外框拟合得到的 sx/sy 进行缩放以适配任意比例图框。
    pipeline:
      - step: 1
        name: dwg_to_dxf
        input: dwg files uploaded via web
        output: dxf files (intermediate, not exported to user)
        implementation_hint: ODA File Converter CLI or ODA Drawings SDK; offline LAN compatible
      - step: 2
        name: frame_candidate_detection
        logic:
          - 解析 DXF：展开 INSERT（块）递归收集 TEXT/MTEXT/ATTRIB；同时收集闭合矩形（优先 LWPOLYLINE closed）
          - 生成候选外框：按面积排序（优先最大矩形），并允许一图多框
          - 对每个候选外框：进入 Step3 复核（锚点 ROI + 文字命中）
      - step: 3
        name: frame_verification_by_anchor_roi
        logic:
          - 对候选外框，先做纸张尺寸拟合，得到 paper_variant 与缩放因子 sx/sy（见 scale_fit）
          - 尝试 ROI profile（BASE10/SMALL5）：在缩放后的 anchor ROI 内搜索锚点文本（CNPE 或 中国核电工程有限公司）
          - 命中则判定为有效图框；若都不命中则丢弃该外框候选
      - step: 4
        name: scale_consistency_check
        logic:
          - 量取几何缩放：sx=W_obs/W_canon, sy=H_obs/H_canon；geom_scale = (sx+sy)/2
          - 读取比例文本（scale_text，例如 1:100），解析出 denominator=X
          - 若 |geom_scale - X| 超过阈值则 flags+=['比例不一致']，但继续运行
      - step: 5
        name: field_roi_extract_and_text_parse
        logic:
          - 按选定 roi_profile 的字段 rb_offset，结合 sx/sy 还原各字段 ROI（绝对坐标）
          - 在 ROI 内提取文本（TEXT/MTEXT/ATTRIB），清理格式码，按 y 分行/按 x 排序拼接
          - 对字段做正则/词典解析，得到结构化参数（工程号/子项号/内外部编码/图幅/专业/比例/张数/标题/版次/状态/日期）
          - 将结果存入后续拆分、重命名、打印与文档生成模块的中间结构
    outer_frame_detection:
      preferred_entities:
        - LWPOLYLINE(closed)
        - POLYLINE(closed)
      fallback: reconstruct rectangle from LINE clusters
      rectangle_acceptance:
        min_area_rank: top-N by area per layout
        orthogonality_tol_deg: 1.0
      multi_frame_in_one_dxf: true

    numeric_precision_policy:
      float_round_decimals: 3
      note: "本文件中的标定/ROI 数值已按 3 位小数保存；算法实现可用 float 计算，容差以 tolerance/roi_profiles.tolerance_abs 等字段为准。"

    scale_fit:
      canonical_variants:
        CNPE_A0+1/2:
          W: 1784.000
          H: 841.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A0+1/4:
          W: 1487.000
          H: 841.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A0+1/8:
          W: 1338.000
          H: 841.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A0H:
          W: 841.000
          H: 1189.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A0:
          W: 1189.000
          H: 841.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A1+1/1:
          W: 1682.000
          H: 594.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A1+1/2:
          W: 1261.000
          H: 594.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A1+1/4:
          W: 1051.000
          H: 594.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A1H:
          W: 594.000
          H: 841.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A1:
          W: 841.000
          H: 594.000
          roi_profile_id_default: RB_PROFILE_BASE10
          note: "A1图纸"
        CNPE_A1_FLOW:
          W: 841.000
          H: 594.000
          roi_profile_id_default: RB_PROFILE_BASE10
          note: "A1流程图"
        CNPE_A2:
          W: 594.000
          H: 420.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A2+1/2:
          W: 891.000
          H: 420.000
          roi_profile_id_default: RB_PROFILE_BASE10
        CNPE_A3:
          W: 420.000
          H: 297.000
          roi_profile_id_default: RB_PROFILE_SMALL5
        CNPE_A4:
          W: 210.000
          H: 297.000
          roi_profile_id_default: RB_PROFILE_SMALL5
      fit_method:
        allow_rotation: true
        uniform_scale_required: true
        uniform_scale_tol_rel: 0.020
        fit_error_metric: max_rel_error(W,H)
      outputs:
        - paper_variant_id
        - paper_size_geom
        - sx
        - sy
        - geom_scale_factor

    roi_profiles:
      RB_PROFILE_BASE10:
        description: CNPE 大图幅/标准版图签：以外框右下角为基准，锚点区 dx_right≈10（其余字段相对关系与之配套）。
        tolerance_abs: 0.500
        fields_rb_offset_1to1:
          外层矩形:
            - 0.000
            - 1189.000
            - 0.000
            - 841.000
          工程号:
            - 96.000
            - 116.000
            - 42.000
            - 52.000
          子项号:
            - 64.000
            - 84.000
            - 42.000
            - 52.000
          内部编码:
            - 10.000
            - 52.000
            - 42.000
            - 52.000
          外部编码:
            - 10.198
            - 190.198
            - 84.000
            - 94.000
          图幅:
            - 10.080
            - 26.000
            - 34.000
            - 42.000
          专业:
            - 10.080
            - 26.000
            - 26.000
            - 34.000
          比例:
            - 10.000
            - 26.000
            - 18.000
            - 26.000
          张数:
            - 10.000
            - 38.000
            - 10.000
            - 18.000
          图纸标题:
            - 38.000
            - 128.000
            - 10.000
            - 42.000
          版次:
            - 178.198
            - 190.000
            - 118.000
            - 141.762
          状态:
            - 144.198
            - 160.198
            - 118.000
            - 141.762
          日期:
            - 160.198
            - 178.198
            - 118.000
            - 141.762
          图框定位-中国核电工程有限公司:
            - 10.000
            - 190.000
            - 52.000
            - 68.000
      RB_PROFILE_SMALL5:
        description: CNPE 小图幅紧凑版图签：相对BASE整体约-5（dx/dy均减5），锚点区 dx_right≈5。已验证适用于A3与A4。
        tolerance_abs: 0.500
        fields_rb_offset_1to1:
          外层矩形:
            - 0.000
            - 420.000
            - 0.000
            - 297.000
          工程号:
            - 91.000
            - 111.000
            - 37.000
            - 47.000
          子项号:
            - 59.000
            - 79.000
            - 37.000
            - 47.000
          内部编码:
            - 5.000
            - 47.000
            - 37.000
            - 47.000
          外部编码:
            - 5.198
            - 185.198
            - 79.000
            - 89.000
          图幅:
            - 5.080
            - 21.000
            - 29.000
            - 37.000
          专业:
            - 5.080
            - 21.000
            - 21.000
            - 29.000
          比例:
            - 5.000
            - 21.000
            - 13.000
            - 21.000
          张数:
            - 5.000
            - 33.000
            - 5.000
            - 13.000
          图纸标题:
            - 33.000
            - 123.000
            - 5.000
            - 37.000
          版次:
            - 173.198
            - 185.000
            - 113.000
            - 136.762
          状态:
            - 139.198
            - 155.198
            - 113.000
            - 136.762
          日期:
            - 155.198
            - 173.198
            - 113.000
            - 136.762
          图框定位-中国核电工程有限公司:
            - 5.000
            - 185.000
            - 47.000
            - 63.000

    # 说明：roi_profiles.fields_rb_offset_1to1 里使用的中文键名，是“ROI 字段名”（运行时用它去找对应的 ROI 框）。
    # 真正的“变量参数名”在 field_definitions 里（external_code/internal_code/engineering_no/...），两者通过
    # field_definitions.<var>.extract_roi_field_name 进行绑定。
    roi_field_name_mapping:
      engineering_no: 工程号
      subitem_no: 子项号
      internal_code: 内部编码
      external_code: 外部编码
      paper_size_text: 图幅
      discipline: 专业
      scale_text: 比例
      page_info: 张数
      title_cn: 图纸标题
      title_en: 图纸标题
      revision: 版次
      status: 状态
      date: 日期
      anchor_text: 图框定位-中国核电工程有限公司

    anchor:
      search_text_any_of:
        - CNPE
        - 中国核电工程有限公司
      profile_priority:
        - RB_PROFILE_BASE10
        - RB_PROFILE_SMALL5
      match_policy: any_hit_accept
    field_definitions:
      external_code:
        purpose: 图纸外部编码
        extract_roi_field_name: 外部编码
        parse:
          type: docno_plus_fixed19
          header: DOC.NO
          fixed_len: 19
          charset: A-Z0-9
      internal_code:
        purpose: 图纸内部编码（专用ROI框内读取全部文本）
        extract_roi_field_name: 内部编码
        parse:
          # 兼容两种格式：
          # - 标准：XXXXXXX-XXXXX-XXX（XXX 从 001 起）
          # - 兼容：XXXXXXX-XXXXX（常见于样例：20161NH-JGS01；其中末2位数字可提炼为图册编号 album_code=01）
          type: internal_code_cnpe
          patterns:
            full: ^(?P<prefix>[A-Z0-9]{7})-(?P<mid>[A-Z0-9]{5})-(?P<seq>[0-9]{3})$
            short: ^(?P<prefix>[A-Z0-9]{7})-(?P<mid>[A-Z0-9]{5})$
            mid_album: ^(?P<mid3>[A-Z0-9]{3})(?P<album>[0-9]{2})$
      album_code:
        purpose: 图册编号（从 internal_code 派生，不新增ROI）
        derive_from: internal_code
        parse:
          type: derived_from_internal_code_album_code
      engineering_no:
        purpose: 工程号（4位数字；与前端 project_no 概念区分，但默认值可能相同）
        extract_roi_field_name: 工程号
        parse:
          type: regex
          pattern: ^[0-9]{4}$
      subitem_no:
        purpose: 子项号（用于封面与目录）
        extract_roi_field_name: 子项号
        parse:
          type: text_exact_or_lexicon
          lexicon_optional: true
      # system_no 已废弃：你已确认改为“系统代码/系统名称”，并且来源为前端输入（默认 NA）
      paper_size_text:
        purpose: 图幅文本（A0/A1/A2/A3/A4 或特殊）
        extract_roi_field_name: 图幅
        parse:
          type: text
      discipline:
        purpose: 专业（例如 结构）
        extract_roi_field_name: 专业
        parse:
          type: text
      scale_text:
        purpose: 比例文本（1:X）
        extract_roi_field_name: 比例
        parse:
          type: regex
          pattern: ^1[:：](\d+(?:\.\d+)?)$
          output:
            scale_denominator: 1
      page_info:
        purpose: 张数信息（共N张 第M张）
        extract_roi_field_name: 张数
        parse:
          # 说明：很多DXF把“共/张/第/张”画成静态线框或不可提取的字形，ROI 内可提取的往往只有两个“变量格”：
          # - 共N张 -> N
          # - 第M张 -> M（可能为数字或 X）
          # 因此采用“auto”解析：优先匹配完整短语（如果短语文本可提取），否则退化为两token解析。
          type: page_info_auto
          pattern: 共\s*(\d+)\s*张.*第\s*([0-9Xx]+)\s*张
          output:
            page_total: 1
            page_index: 2
      title_cn:
        purpose: 图纸中文标题（从“图纸标题”ROI内文本行分流得到；含块内/多行）
        extract_roi_field_name: 图纸标题
        parse:
          type: title_bilingual_split
        note:
          - "按“文本行”处理：先在ROI内收集 TEXT/MTEXT/ATTRIB（含块内INSERT递归展开），按y聚类成行、按x排序拼接成行文本。"
          - "对每一行：若包含中文（CJK）字符则归为中文候选；若全为英文/数字/符号则归为英文候选。"
          - "中文候选按y从大到小（从上到下）拼接为 title_cn；英文候选同理拼接为 title_en。"
      title_en:
        purpose: 图纸英文标题（仅当ROI内存在纯英文行时产出；1818项目通常需要）
        extract_roi_field_name: 图纸标题
        parse:
          type: title_bilingual_split
        note:
          - "与 title_cn 共用同一ROI与分流逻辑；不新增ROI。若ROI内无纯英文行则可为空。"
      revision:
        purpose: 版次（修订表“版次/日期/状态”三列之一）
        extract_roi_field_name: 版次
        parse:
          type: pick_top_by_y
        note:
          - "本项目约定：修订表三列（版次/日期/状态）在DXF中是独立文本实体；提取时只按文本插入点(x,y)是否落在ROI内判定命中（不使用bbox相交的近似命中，避免跨列误带入）。"
          - "列内可能存在多行（例如A行/B行）；最终取值规则为：选择该列ROI内 y 值最大的文本（最靠上/最高行）。"
      status:
        purpose: 状态（修订表“版次/日期/状态”三列之一）
        extract_roi_field_name: 状态
        parse:
          type: pick_top_by_y
        note:
          - "命中判定与取值规则同 revision：point-only 命中；列内取 y 最大的文本作为最终状态。"
      date:
        purpose: 日期（修订表“版次/日期/状态”三列之一；当前阶段可不参与业务逻辑，但保留）
        extract_roi_field_name: 日期
        parse:
          type: pick_top_by_y
        note:
          - "命中判定与取值规则同 revision：point-only 命中；列内取 y 最大的日期文本作为最终日期。"
    tolerance:
      roi_margin_percent: 0.020
      text_grouping:
        y_cluster_abs: 1.000
        line_join: "\n"
      scale_mismatch:
        abs_tol: 0.500
        rel_tol: 0.020
        flag_name: 比例不一致
        continue_on_mismatch: true

